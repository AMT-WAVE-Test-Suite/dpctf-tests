<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="../lib/style.css" />
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
  </head>

  <body>
    <div id="content-wrapper">
      <div id="video-wrapper">
        <video></video>
        <div><div id="qr-code"></div></div>
      </div>
      <div>
        Press Enter/Ok to continue or Up/Down to show/hide debug overlay
      </div>
      <div id="debug"></div>
      <div id="log"></div>
    </div>
    <div id="info-overlay"></div>
    <script src="../lib/mozilla/object-keys-polyfill.js"></script>
    <script src="../lib/stefanpenner/es6-promise.min.js"></script>
    <script src="../lib/player.js"></script>
    <script src="../lib/manifest_parser.js"></script>
    <script src="../lib/mpd-parser.js"></script>
    <script src="../lib/wave-service.js"></script>
    <script src="../lib/davidshimjs/qrcode.js"></script>
    <script src="../lib/dpctf-testharness.js"></script>
    <script>
      // Global variables
      var TEST_INFO = {
        title: "Overlapping Fragments",
        description:
          "Playback of overlapping fragments assumes that the application can overwrite the buffer with other fragments. This is for example useful in case that a fragment is loaded in lower quality but may then be replaced by a better-quality fragment.",
        path: "Folder3/overlapping-fragments-manual__ToS_MultiRate_fragmented__ToS_HEAACv2_fragmented.html",
        code: "overlapping-fragments-manual.html",
        params: urlParams,
        observations: [],
      };

      var video = document.querySelector("video");
      var qrCode = document.getElementById("qr-code");
      var overwriteCurrentFragment = true;

      var videoContentModel = "http://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Fragmented/ToS_MultiRate_fragmented.mpd";
      var audioContentModel = "https://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Fragmented/ToS_HEAACv2_fragmented.mpd";

      var dpctfTest = new DpctfTest({
        testInfo: TEST_INFO,
        videoContentModel: videoContentModel,
        audioContentModel: audioContentModel,
        videoElement: video,
        qrCodeElement: qrCode,
        infoOverlayElement: document.getElementById("info-overlay"),
        executeTest: executeTest,
        usePlayout: true,
      });

      function executeTest(player, done, parameters) {
        var minBufferDuration = parameters.minBufferDuration / 1000;

        var handleRandomSwitch = function (currentTime) {
          var duration = player.getDuration();
          var switchingTime = duration * 0.3;

          if (currentTime < switchingTime) return;
          if (Math.random() > 0.05) return;

          var newRepresentationIndex = 1;

          var totalSegmentsCount = player
            .getVideoManifest()
            .getRepresentation(newRepresentationIndex)
            .getTotalSegmentsCount();
          var switchingSegment = player.getPlayingVideoSegment().getNumber();
          if (!overwriteCurrentFragment) {
            switchingSegment += 1;
          }
          player.setVideoSegments({
            representationNumber: 1,
            startSegment: switchingSegment,
            endSegment: totalSegmentsCount - 1,
          });
          player.off(handleRandomSwitch);
        };
        player.on("onTimeUpdate", handleRandomSwitch);

        player.startBuffering();
        if (player.getPreBufferedTime() >= minBufferDuration) {
          player.play();
        } else {
          player.on("onVideoSegmentLoaded", function (event) {
            if (player.getPreBufferedTime() >= minBufferDuration) {
              player.play();
            }
          });
        }

        dpctfTest.asyncTest(function (test) {
          var query = location.search.replace(/\?/, "");
          var match = query.match(/redirect_time=([^&]+)/);
          var REDIRECT_TIME = match ? match[1] : null;
          if (!REDIRECT_TIME) REDIRECT_TIME = 5;
          video.addEventListener("ended", function (event) {
            setTimeout(
              test.step_func(function () {
                assert_true(true);
                test.done();
              }),
              REDIRECT_TIME * 1000
            );
          });
        }, "video ended event fired");

        done();
      }
    </script>
  </body>
</html>
