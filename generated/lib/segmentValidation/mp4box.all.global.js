var MP4Box=(()=>{var Nn=Object.defineProperty;var go=Object.getOwnPropertyDescriptor;var So=Object.getOwnPropertyNames;var Bo=Object.prototype.hasOwnProperty;var ro=s=>{throw TypeError(s)};var Rn=(s,t)=>{for(var e in t)Nn(s,e,{get:t[e],enumerable:!0})},Uo=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of So(t))!Bo.call(s,r)&&r!==e&&Nn(s,r,{get:()=>t[r],enumerable:!(i=go(t,r))||i.enumerable});return s};var wo=s=>Uo(Nn({},"__esModule",{value:!0}),s);var On=(s,t,e)=>t.has(s)||ro("Cannot "+e);var so=(s,t,e)=>(On(s,t,"read from private field"),e?e.call(s):t.get(s)),ct=(s,t,e)=>t.has(s)?ro("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),no=(s,t,e,i)=>(On(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e),Hn=(s,t,e)=>(On(s,t,"access private method"),e);var Do={};Rn(Do,{AudioSampleEntry:()=>k,Box:()=>c,BoxParser:()=>Eo,DIFF_BOXES_PROP_NAMES:()=>ht,DIFF_PRIMITIVE_ARRAY_PROP_NAMES:()=>mo,DataStream:()=>E,Descriptor:()=>Y,ES_Descriptor:()=>lt,Endianness:()=>_e,FullBox:()=>f,HintSampleEntry:()=>be,ISOFile:()=>ft,Log:()=>u,MP4BoxBuffer:()=>H,MP4BoxStream:()=>V,MPEG4DescriptorParser:()=>nr,MetadataSampleEntry:()=>N,MultiBufferStream:()=>Z,SampleEntry:()=>C,SampleGroupEntry:()=>b,SampleGroupInfo:()=>Qe,SingleItemTypeReferenceBox:()=>it,SingleItemTypeReferenceBoxLarge:()=>rt,SubtitleSampleEntry:()=>D,SystemSampleEntry:()=>X,TextSampleEntry:()=>ot,Textin4Parser:()=>Qn,TrackGroupTypeBox:()=>tt,TrackReferenceTypeBox:()=>st,VTTin4Parser:()=>Xn,VisualSampleEntry:()=>B,XMLSubtitlein4Parser:()=>Jn,boxEqual:()=>_t,boxEqualFields:()=>ho,createFile:()=>To});var w=Math.pow(2,32),oo=1,ao=2,fo=4,de=1,ue=2,ce=8,pe=16,me=32;var Vn=131072,ee=1,he=4,te=256,ie=512,re=1024,se=2048;var q=0,v=1;var H=class extends ArrayBuffer{constructor(t){super(t),this.fileStart=0,this.usedBytes=0}static fromArrayBuffer(t,e){let i=t;return i.fileStart=e,i.usedBytes=0,i}};var _e=(e=>(e[e.BIG_ENDIAN=1]="BIG_ENDIAN",e[e.LITTLE_ENDIAN=2]="LITTLE_ENDIAN",e))(_e||{}),et,Gn,g=class g{constructor(t,e,i){ct(this,et);this._byteLength=0;this.failurePosition=0;this._dynamicSize=1;this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=H.fromArrayBuffer(t,0):t instanceof DataView?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new H(t||0),this.position=0,this.endianness=i||2}getPosition(){return this.position}_realloc(t){if(!this._dynamicSize)return;let e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i){e>this._byteLength&&(this._byteLength=e);return}for(i<1&&(i=1);e>i;)i*=2;let r=new H(i),n=new Uint8Array(this._buffer);new Uint8Array(r,0,n.length).set(n),this.buffer=r,this._byteLength=e}_trimAlloc(){if(this._byteLength===this._buffer.byteLength)return;let t=new H(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(t){this._buffer=t,this._dataView=new DataView(t,this._byteOffset),this._byteLength=t.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(t){this._byteOffset=t.byteOffset,this._buffer=H.fromArrayBuffer(t.buffer,0),this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}seek(t){let e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e}isEof(){return this.position>=this._byteLength}mapUint8Array(t){this._realloc(t*1);let e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e}readInt32Array(t,e){t=t===null?this.byteLength-this.position/4:t;let i=new Int32Array(t);return g.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),g.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readInt16Array(t,e){t=t===null?this.byteLength-this.position/2:t;let i=new Int16Array(t);return g.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),g.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readInt8Array(t){t=t===null?this.byteLength-this.position:t;let e=new Int8Array(t);return g.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e}readUint32Array(t,e){t=t===null?this.byteLength-this.position/4:t;let i=new Uint32Array(t);return g.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),g.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readUint16Array(t,e){t=t===null?this.byteLength-this.position/2:t;let i=new Uint16Array(t);return g.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),g.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readUint8Array(t){t=t===void 0?this.byteLength-this.position:t;let e=new Uint8Array(t);return g.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e}readFloat64Array(t,e){t=t===null?this.byteLength-this.position/8:t;let i=new Float64Array(t);return g.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),g.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readFloat32Array(t,e){t=t===null?this.byteLength-this.position/4:t;let i=new Float32Array(t);return g.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),g.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readInt32(t){let e=this._dataView.getInt32(this.position,(t!=null?t:this.endianness)===2);return this.position+=4,e}readInt16(t){let e=this._dataView.getInt16(this.position,(t!=null?t:this.endianness)===2);return this.position+=2,e}readInt8(){let t=this._dataView.getInt8(this.position);return this.position+=1,t}readUint32(t){let e=this._dataView.getUint32(this.position,(t!=null?t:this.endianness)===2);return this.position+=4,e}readUint16(t){let e=this._dataView.getUint16(this.position,(t!=null?t:this.endianness)===2);return this.position+=2,e}readUint8(){let t=this._dataView.getUint8(this.position);return this.position+=1,t}readFloat32(t){let e=this._dataView.getFloat32(this.position,(t!=null?t:this.endianness)===2);return this.position+=4,e}readFloat64(t){let e=this._dataView.getFloat64(this.position,(t!=null?t:this.endianness)===2);return this.position+=8,e}static memcpy(t,e,i,r,n){let o=new Uint8Array(t,e,n),a=new Uint8Array(i,r,n);o.set(a)}static arrayToNative(t,e){return e===g.ENDIANNESS?t:this.flipArrayEndianness(t)}static nativeToEndian(t,e){return e&&g.ENDIANNESS===2?t:this.flipArrayEndianness(t)}static flipArrayEndianness(t){let e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(let r=i+t.BYTES_PER_ELEMENT-1,n=i;r>n;r--,n++){let o=e[n];e[n]=e[r],e[r]=o}return t}readString(t,e){return e===null||e==="ASCII"?lo(this.mapUint8Array(t===null?this.byteLength-this.position:t)):new TextDecoder(e).decode(this.mapUint8Array(t))}readCString(t){let e=0,i=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),n=t!==void 0?Math.min(t,i):i;for(;e<n&&r[e]!==0;e++);let o=lo(this.mapUint8Array(e));return t!==void 0?this.position+=n-e:e!==i&&(this.position+=1),o}readInt64(){return this.readInt32()*w+this.readUint32()}readUint64(){return this.readUint32()*w+this.readUint32()}readUint24(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()}save(t){let e=new Blob([this.buffer]);if(typeof window!="undefined"&&typeof document!="undefined")if(window.URL&&URL.createObjectURL){let i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.setAttribute("href",i),r.setAttribute("download",t),r.setAttribute("target","_self"),r.click(),window.URL.revokeObjectURL(i),document.body.removeChild(r)}else throw new Error("DataStream.save: Can't create object URL.");return e}get dynamicSize(){return this._dynamicSize}set dynamicSize(t){t||this._trimAlloc(),this._dynamicSize=t}shift(t){let e=new H(this._byteLength-t),i=new Uint8Array(e),r=new Uint8Array(this._buffer,t,i.length);i.set(r),this.buffer=e,this.position-=t}writeInt32Array(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeInt32(t[i],e)}writeInt16Array(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeInt16(t[i],e)}writeInt8Array(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(let e=0;e<t.length;e++)this.writeInt8(t[e])}writeUint32Array(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeUint32(t[i],e)}writeUint16Array(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeUint16(t[i],e)}writeUint8Array(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(let e=0;e<t.length;e++)this.writeUint8(t[e])}writeFloat64Array(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeFloat64(t[i],e)}writeFloat32Array(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)g.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeFloat32(t[i],e)}writeInt64(t,e){this._realloc(8),this._dataView.setBigInt64(this.position,BigInt(t),(e!=null?e:this.endianness)===2),this.position+=8}writeInt32(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,(e!=null?e:this.endianness)===2),this.position+=4}writeInt16(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,(e!=null?e:this.endianness)===2),this.position+=2}writeInt8(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1}writeUint32(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,(e!=null?e:this.endianness)===2),this.position+=4}writeUint16(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,(e!=null?e:this.endianness)===2),this.position+=2}writeUint8(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1}writeFloat32(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,(e!=null?e:this.endianness)===2),this.position+=4}writeFloat64(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,(e!=null?e:this.endianness)===2),this.position+=8}writeUCS2String(t,e,i){i===null&&(i=t.length);let r;for(r=0;r<t.length&&r<i;r++)this.writeUint16(t.charCodeAt(r),e);for(;r<i;r++)this.writeUint16(0)}writeString(t,e,i){let r=0;if(e===null||e==="ASCII")if(i!==null){let n=Math.min(t.length,i);for(r=0;r<n;r++)this.writeUint8(t.charCodeAt(r));for(;r<i;r++)this.writeUint8(0)}else for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))}writeCString(t,e){let i=0;if(e!==void 0){let r=Math.min(t.length,e);for(i=0;i<r;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}}writeStruct(t,e){for(let i=0;i<t.length;i++){let[r,n]=t[i],o=e[r];this.writeType(n,o,e)}}writeType(t,e,i){if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,i);let r=null,n="ASCII",o=this.position,a=t;if(typeof t=="string"&&/:/.test(t)){let l=t.split(":");a=l[0],r=parseInt(l[1])}if(typeof a=="string"&&/,/.test(a)){let l=a.split(",");a=l[0],n=l[1]}switch(a){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,1);break;case"int16be":this.writeInt16(e,1);break;case"uint32be":this.writeUint32(e,1);break;case"int32be":this.writeInt32(e,1);break;case"float32be":this.writeFloat32(e,1);break;case"float64be":this.writeFloat64(e,1);break;case"uint16le":this.writeUint16(e,2);break;case"int16le":this.writeInt16(e,2);break;case"uint32le":this.writeUint32(e,2);break;case"int32le":this.writeInt32(e,2);break;case"float32le":this.writeFloat32(e,2);break;case"float64le":this.writeFloat64(e,2);break;case"cstring":this.writeCString(e,r);break;case"string":this.writeString(e,n,r);break;case"u16string":this.writeUCS2String(e,this.endianness,r);break;case"u16stringle":this.writeUCS2String(e,2,r);break;case"u16stringbe":this.writeUCS2String(e,1,r);break;default:if(Hn(this,et,Gn).call(this,a)){let[,l]=a;for(let d=0;d<e.length;d++)this.writeType(l,e[d]);break}else{this.writeStruct(a,e);break}}r!==null&&(this.position=o,this._realloc(r),this.position=o+r)}writeUint64(t){let e=Math.floor(t/w);this.writeUint32(e),this.writeUint32(t&4294967295)}writeUint24(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)}adjustUint32(t,e){let i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)}readStruct(t){let e={},i=this.position;for(let r=0;r<t.length;r+=1){let n=t[r][1],o=this.readType(n,e);if(o===null)return this.failurePosition===0&&(this.failurePosition=this.position),this.position=i,null;e[t[r][0]]=o}return e}readUCS2String(t,e){return String.fromCharCode.apply(null,this.readUint16Array(t,e))}readType(t,e){if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.get(this,e);if(t instanceof Array&&t.length!==3)return this.readStruct(t);let i=null,r=null,n="ASCII",o=this.position,a=t;if(typeof a=="string"&&/:/.test(a)){let l=a.split(":");a=l[0],r=parseInt(l[1])}if(typeof a=="string"&&/,/.test(a)){let l=a.split(",");a=l[0],n=l[1]}switch(a){case"uint8":i=this.readUint8();break;case"int8":i=this.readInt8();break;case"uint16":i=this.readUint16(this.endianness);break;case"int16":i=this.readInt16(this.endianness);break;case"uint32":i=this.readUint32(this.endianness);break;case"int32":i=this.readInt32(this.endianness);break;case"float32":i=this.readFloat32(this.endianness);break;case"float64":i=this.readFloat64(this.endianness);break;case"uint16be":i=this.readUint16(1);break;case"int16be":i=this.readInt16(1);break;case"uint32be":i=this.readUint32(1);break;case"int32be":i=this.readInt32(1);break;case"float32be":i=this.readFloat32(1);break;case"float64be":i=this.readFloat64(1);break;case"uint16le":i=this.readUint16(2);break;case"int16le":i=this.readInt16(2);break;case"uint32le":i=this.readUint32(2);break;case"int32le":i=this.readInt32(2);break;case"float32le":i=this.readFloat32(2);break;case"float64le":i=this.readFloat64(2);break;case"cstring":i=this.readCString(r);break;case"string":i=this.readString(r,n);break;case"u16string":i=this.readUCS2String(r,this.endianness);break;case"u16stringle":i=this.readUCS2String(r,2);break;case"u16stringbe":i=this.readUCS2String(r,1);break;default:if(Hn(this,et,Gn).call(this,a)){let[,l,d]=a,p=typeof d=="function"?d(e,this,a):typeof d=="string"&&e[d]!==null?parseInt(e[d]):typeof d=="number"?d:d==="*"?null:parseInt(d);if(typeof l=="string"){let h=l.replace(/(le|be)$/,""),m;switch(/le$/.test(l)?m=2:/be$/.test(l)&&(m=1),h){case"uint8":i=this.readUint8Array(p);break;case"uint16":i=this.readUint16Array(p,m);break;case"uint32":i=this.readUint32Array(p,m);break;case"int8":i=this.readInt8Array(p);break;case"int16":i=this.readInt16Array(p,m);break;case"int32":i=this.readInt32Array(p,m);break;case"float32":i=this.readFloat32Array(p,m);break;case"float64":i=this.readFloat64Array(p,m);break;case"cstring":case"utf16string":case"string":if(p===null)for(i=[];!this.isEof();){let _=this.readType(l,e);if(_===null)break;i.push(_)}else{i=new Array(p);for(let _=0;_<p;_++)i[_]=this.readType(l,e)}break}}else if(p===null)for(i=[];;){let h=this.position;try{let m=this.readType(l,e);if(m===null){this.position=h;break}i.push(m)}catch(m){this.position=h;break}}else{i=new Array(p);for(let h=0;h<p;h++){let m=this.readType(l,e);if(m===null)return null;i[h]=m}}break}}return r!==null&&(this.position=o+r),i}mapInt32Array(t,e){this._realloc(t*4);let i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return g.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*4,i}mapInt16Array(t,e){this._realloc(t*2);let i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return g.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*2,i}mapInt8Array(t,e){this._realloc(t*1);let i=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,i}mapUint32Array(t,e){this._realloc(t*4);let i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return g.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*4,i}mapUint16Array(t,e){this._realloc(t*2);let i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return g.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*2,i}mapFloat64Array(t,e){this._realloc(t*8);let i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return g.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*8,i}mapFloat32Array(t,e){this._realloc(t*4);let i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return g.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*4,i}};et=new WeakSet,Gn=function(t){return Array.isArray(t)&&t.length===3&&t[0]==="[]"},g.ENDIANNESS=new Int8Array(new Int16Array([1]).buffer)[0]>0?2:1;var E=g;function lo(s){let t=[];for(let e=0;e<s.length;e++)t[e]=s[e];return String.fromCharCode.apply(null,t)}var pt=new Date,mt=4,uo=3,co=2,po=1,$=mt,u={setLogLevel(s){s===this.debug?$=po:s===this.info?$=co:s===this.warn?$=uo:(this.error,$=mt)},debug(s,t){console.debug===void 0&&(console.debug=console.log),po>=$&&console.debug("["+u.getDurationString(new Date().getTime()-pt.getTime(),1e3)+"]","["+s+"]",t)},log(s,t){this.debug(s.msg)},info(s,t){co>=$&&console.info("["+u.getDurationString(new Date().getTime()-pt.getTime(),1e3)+"]","["+s+"]",t)},warn(s,t){uo>=$&&console.warn("["+u.getDurationString(new Date().getTime()-pt.getTime(),1e3)+"]","["+s+"]",t)},error(s,t){mt>=$&&console.error("["+u.getDurationString(new Date().getTime()-pt.getTime(),1e3)+"]","["+s+"]",t)},getDurationString(s,t){let e;function i(d,p){let m=(""+d).split(".");for(;m[0].length<p;)m[0]="0"+m[0];return m.join(".")}s<0?(e=!0,s=-s):e=!1;let n=s/(t||1),o=Math.floor(n/3600);n-=o*3600;let a=Math.floor(n/60);n-=a*60;let l=n*1e3;return n=Math.floor(n),l-=n*1e3,l=Math.floor(l),(e?"-":"")+o+":"+i(a,2)+":"+i(n,2)+"."+i(l,3)},printRanges(s){let t=s.length;if(t>0){let e="";for(let i=0;i<t;i++)i>0&&(e+=","),e+="["+u.getDurationString(s.start(i))+","+u.getDurationString(s.end(i))+"]";return e}else return"(empty)"}};function Ao(s,t){u.debug("ArrayBuffer","Trying to create a new buffer of size: "+(s.byteLength+t.byteLength));let e=new Uint8Array(s.byteLength+t.byteLength);return e.set(new Uint8Array(s),0),e.set(new Uint8Array(t),s.byteLength),e.buffer}var Z=class extends E{constructor(t){super(new ArrayBuffer,0,1),this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)}initialized(){if(this.bufferIndex>-1)return!0;if(this.buffers.length>0){let t=this.buffers[0];return t.fileStart===0?(this.buffer=t,this.bufferIndex=0,u.debug("MultiBufferStream","Stream ready for parsing"),!0):(u.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)}else return u.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1}reduceBuffer(t,e,i){let r=new Uint8Array(i);return r.set(new Uint8Array(t,e,i)),r.buffer.fileStart=t.fileStart+e,r.buffer.usedBytes=0,r.buffer}insertBuffer(t){let e=!0,i=0;for(;i<this.buffers.length;i++){let r=this.buffers[i];if(t.fileStart<=r.fileStart){if(t.fileStart===r.fileStart)if(t.byteLength>r.byteLength){this.buffers.splice(i,1),i--;continue}else u.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=r.fileStart||(t=this.reduceBuffer(t,0,r.fileStart-t.fileStart)),u.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(i,0,t),i===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<r.fileStart+r.byteLength){let n=r.fileStart+r.byteLength-t.fileStart,o=t.byteLength-n;if(o>0)t=this.reduceBuffer(t,n,o);else{e=!1;break}}}e&&(u.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),i===0&&(this.buffer=t))}logBufferLevel(t){let e=[],i="",r,n=0,o=0;for(let l=0;l<this.buffers.length;l++){let d=this.buffers[l];l===0?(r={start:d.fileStart,end:d.fileStart+d.byteLength},e.push(r),i+="["+r.start+"-"):r.end===d.fileStart?r.end=d.fileStart+d.byteLength:(r={start:d.fileStart,end:d.fileStart+d.byteLength},i+=e[e.length-1].end-1+"], ["+r.start+"-",e.push(r)),n+=d.usedBytes,o+=d.byteLength}e.length>0&&(i+=r.end-1+"]");let a=t?u.info:u.debug;this.buffers.length===0?a("MultiBufferStream","No more buffer in memory"):a("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+n+"/"+o+" bytes), continuous ranges: "+i)}cleanBuffers(){for(let t=0;t<this.buffers.length;t++){let e=this.buffers[t];e.usedBytes===e.byteLength&&(u.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)}}mergeNextBuffer(){if(this.bufferIndex+1<this.buffers.length){let t=this.buffers[this.bufferIndex+1];if(t.fileStart===this.buffer.fileStart+this.buffer.byteLength){let e=this.buffer.byteLength,i=this.buffer.usedBytes,r=this.buffer.fileStart;return this.buffers[this.bufferIndex]=Ao(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=r,u.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1}else return!1}findPosition(t,e,i){let r=-1,n=t===!0?0:this.bufferIndex;for(;n<this.buffers.length;){let a=this.buffers[n];if(a&&a.fileStart<=e)r=n,i&&(a.fileStart+a.byteLength<=e?a.usedBytes=a.byteLength:a.usedBytes=e-a.fileStart,this.logBufferLevel());else break;n++}if(r===-1)return-1;let o=this.buffers[r];return o.fileStart+o.byteLength>=e?(u.debug("MultiBufferStream","Found position in existing buffer #"+r),r):-1}findEndContiguousBuf(t){let e=t!==void 0?t:this.bufferIndex,i=this.buffers[e];if(this.buffers.length>e+1)for(let r=e+1;r<this.buffers.length;r++){let n=this.buffers[r];if(n.fileStart===i.fileStart+i.byteLength)i=n;else break}return i.fileStart+i.byteLength}getEndFilePositionAfter(t){let e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t}addUsedBytes(t){this.buffer.usedBytes+=t,this.logBufferLevel()}setAllUsedBytes(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()}seek(t,e,i){let r=this.findPosition(e,t,i);return r!==-1?(this.buffer=this.buffers[r],this.bufferIndex=r,this.position=t-this.buffer.fileStart,u.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(u.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)}getPosition(){return this.bufferIndex===-1||this.buffers[this.bufferIndex]===null?0:this.buffers[this.bufferIndex].fileStart+this.position}getLength(){return this.byteLength}getEndPosition(){return this.bufferIndex===-1||this.buffers[this.bufferIndex]===null?0:this.buffers[this.bufferIndex].fileStart+this.byteLength}getAbsoluteEndPosition(){if(this.buffers.length===0)return 0;let t=this.buffers[this.buffers.length-1];return t.fileStart+t.byteLength}};var V=class{constructor(t){this.position=0;if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw new Error("Needs an array buffer")}getPosition(){return this.position}getEndPosition(){return this.buffer.byteLength}getLength(){return this.buffer.byteLength}seek(t){let e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0}isEos(){return this.getPosition()>=this.getEndPosition()}readAnyInt(t,e){let i=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?i=this.dataview.getInt8(this.position):i=this.dataview.getUint8(this.position);break;case 2:e?i=this.dataview.getInt16(this.position):i=this.dataview.getUint16(this.position);break;case 3:if(e)throw new Error("No method for reading signed 24 bits values");i=this.dataview.getUint8(this.position)<<16,i|=this.dataview.getUint8(this.position+1)<<8,i|=this.dataview.getUint8(this.position+2);break;case 4:e?i=this.dataview.getInt32(this.position):i=this.dataview.getUint32(this.position);break;case 8:if(e)throw new Error("No method for reading signed 64 bits values");i=this.dataview.getUint32(this.position)<<32,i|=this.dataview.getUint32(this.position+4);break;default:throw new Error("readInt method not implemented for size: "+t)}return this.position+=t,i}else throw new Error("Not enough bytes in buffer")}readUint8(){return this.readAnyInt(1,!1)}readUint16(){return this.readAnyInt(2,!1)}readUint24(){return this.readAnyInt(3,!1)}readUint32(){return this.readAnyInt(4,!1)}readUint64(){return this.readAnyInt(8,!1)}readString(t){if(this.position+t<=this.buffer.byteLength){let e="";for(let i=0;i<t;i++)e+=String.fromCharCode(this.readUint8());return e}else throw new Error("Not enough bytes in buffer")}readCString(){let t=[];for(;;){let e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)}readInt8(){return this.readAnyInt(1,!0)}readInt16(){return this.readAnyInt(2,!0)}readInt32(){return this.readAnyInt(4,!0)}readInt64(){return this.readAnyInt(8,!1)}readUint8Array(t){let e=new Uint8Array(t);for(let i=0;i<t;i++)e[i]=this.readUint8();return e}readInt16Array(t){let e=new Int16Array(t);for(let i=0;i<t;i++)e[i]=this.readInt16();return e}readUint16Array(t){let e=new Int16Array(t);for(let i=0;i<t;i++)e[i]=this.readUint16();return e}readUint32Array(t){let e=new Uint32Array(t);for(let i=0;i<t;i++)e[i]=this.readUint32();return e}readInt32Array(t){let e=new Int32Array(t);for(let i=0;i<t;i++)e[i]=this.readInt32();return e}};var nt,c=class{constructor(t=0){this.size=t;ct(this,nt)}get type(){var t;return(t=this.constructor.fourcc)!=null?t:so(this,nt)}set type(t){no(this,nt,t)}addBox(t){return this.boxes||(this.boxes=[]),this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t}set(t,e){return this[t]=e,this}addEntry(t,e){let i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this}writeHeader(t,e){if(this.size+=8,(this.size>w||this.original_size===1)&&(this.size+=8),this.type==="uuid"&&(this.size+=16),u.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.original_size===0?t.writeUint32(0):this.size>w||this.original_size===1?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"){let i=new Uint8Array(16);for(let r=0;r<16;r++)i[r]=parseInt(this.uuid.substring(r*2,r*2+2),16);t.writeUint8Array(i)}(this.size>w||this.original_size===1)&&(this.sizePosition=t.getPosition(),t.writeUint64(this.size))}write(t){if(this.type==="mdat"){let e=this;if(e.stream){this.size=e.stream.getAbsoluteEndPosition(),this.writeHeader(t);for(let i of e.stream.buffers){let r=new Uint8Array(i);t.writeUint8Array(r)}}}else this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data)}printHeader(t){this.size+=8,this.size>w&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)}print(t){this.printHeader(t)}parse(t){this.type!=="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)}parseDataAndRewind(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.seek(this.start+this.hdr_size)}parseLanguage(t){this.language=t.readUint16();let e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)}computeSize(t){let e=t||new Z;e.endianness=1,this.write(e)}isEndOfBox(t){let e=t.getPosition(),i=this.start+this.size;return e===i}};nt=new WeakMap,c.registryId=Symbol.for("BoxIdentifier");var f=class extends c{constructor(){super(...arguments);this.flags=0;this.version=0}writeHeader(e){this.size+=4,super.writeHeader(e," v="+this.version+" f="+this.flags),e.writeUint8(this.version),e.writeUint24(this.flags)}printHeader(e){this.size+=4,super.printHeader(e),e.log(e.indent+"version:"+this.version),e.log(e.indent+"flags:"+this.flags)}parseDataAndRewind(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,e.seek(this.start+this.hdr_size)}parseFullHeader(e){this.version=e.readUint8(),this.flags=e.readUint24(),this.hdr_size+=4}parse(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)}},b=class{constructor(t){this.grouping_type=t}write(t){t.writeUint8Array(this.data)}parse(t){u.warn("BoxParser",`Unknown sample group type: '${this.grouping_type}'`),this.data=t.readUint8Array(this.description_length)}};b.registryId=Symbol.for("SampleGroupEntryIdentifier");var tt=class extends f{parse(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()}},it=class extends c{constructor(e,i,r,n,o){super(i);this.box_name=r;this.hdr_size=n;this.start=o;this.type=e}parse(e){this.from_item_ID=e.readUint16();let i=e.readUint16();this.references=[];for(let r=0;r<i;r++)this.references[r]={to_item_ID:e.readUint16()}}},rt=class extends c{constructor(e,i,r,n,o){super(i);this.box_name=r;this.hdr_size=n;this.start=o;this.type=e}parse(e){this.from_item_ID=e.readUint32();let i=e.readUint16();this.references=[];for(let r=0;r<i;r++)this.references[r]={to_item_ID:e.readUint32()}}},st=class extends c{constructor(e,i,r,n){super(i);this.hdr_size=r;this.start=n;this.type=e}parse(e){this.track_ids=e.readUint32Array((this.size-this.hdr_size)/4)}write(e){this.size=this.track_ids.length*4,this.writeHeader(e),e.writeUint32Array(this.track_ids)}};var ht=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],mo=["compatible_brands","matrix","opcolor","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];function ho(s,t){if(s&&!t)return!1;let e;for(e in s)if(!ht.find(i=>i===e)){if(s[e]instanceof c||t[e]instanceof c)continue;if(typeof s[e]=="undefined"||typeof t[e]=="undefined")continue;if(typeof s[e]=="function"||typeof t[e]=="function")continue;if("subBoxNames"in s&&s.subBoxNames.indexOf(e.slice(0,4))>-1||"subBoxNames"in t&&t.subBoxNames.indexOf(e.slice(0,4))>-1)continue;if(e==="data"||e==="start"||e==="size"||e==="creation_time"||e==="modification_time")continue;if(mo.find(i=>i===e))continue;if(s[e]!==t[e])return!1}return!0}function _t(s,t){if(!ho(s,t))return!1;for(let e=0;e<ht.length;e++){let i=ht[e];if(s[i]&&t[i]&&!_t(s[i],t[i]))return!1}return!0}function jn(s){let t=s;for(;t;){if("registryId"in t)return t.registryId;t=Object.getPrototypeOf(t)}}var vo=s=>{let t=Symbol.for("SampleGroupEntryIdentifier");return jn(s)===t},Mo=s=>{let t=Symbol.for("SampleEntryIdentifier");return jn(s)===t},Io=s=>{let t=Symbol.for("BoxIdentifier");return jn(s)===t},M={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};function _o(s){for(let[t,e]of Object.entries(s)){if(vo(e)){let i="grouping_type"in e?e.grouping_type:void 0;if(!i)throw new Error(`SampleGroupEntry class ${t} does not have a valid static grouping_type. Please ensure it is defined correctly.`);if(i in M.sampleGroupEntry)throw new Error(`SampleGroupEntry class ${t} has a grouping_type that is already registered. Please ensure it is unique.`);M.sampleGroupEntry[i]=e;continue}if(Mo(e)){let i="fourcc"in e?e.fourcc:void 0;if(!i)throw new Error(`SampleEntry class ${t} does not have a valid static fourcc. Please ensure it is defined correctly.`);if(i in M.sampleEntry)throw new Error(`SampleEntry class ${t} has a fourcc that is already registered. Please ensure it is unique.`);M.sampleEntry[i]=e;continue}if(Io(e)){let i="fourcc"in e?e.fourcc:null,r="uuid"in e?e.uuid:null;if(i==="uuid"){if(!r)throw new Error(`Box class ${t} has a fourcc of 'uuid' but does not have a valid uuid. Please ensure it is defined correctly.`);if(r in M.uuid)throw new Error(`Box class ${t} has a uuid that is already registered. Please ensure it is unique.`);M.uuid[r]=e;continue}M.box[i]=e;continue}throw new Error(`Box class ${t} does not have a valid static fourcc, uuid, or grouping_type. Please ensure it is defined correctly.`)}return s}var bt={};function bo(s){return Object.entries(s).forEach(([t,e])=>bt[t]=e),s}function zo(s){return G(s)}function G(s){let t="";for(let e=0;e<16;e++){let i=s.readUint8().toString(16);t+=i.length===1?"0"+i:i}return t}function I(s,t,e){let i,r,n=s.getPosition(),o=0,a;if(s.getEndPosition()-n<8)return u.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:q};if(e&&e<8)return u.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:q};let l=s.readUint32(),d=s.readString(4),p=d;if(u.debug("BoxParser","Found box of type '"+d+"' and size "+l+" at position "+n),o=8,d==="uuid"){if(s.getEndPosition()-s.getPosition()<16||e-o<16)return s.seek(n),u.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:q};a=zo(s),o+=16,p=a}if(l===1){if(s.getEndPosition()-s.getPosition()<8||e&&e-o<8)return s.seek(n),u.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+d+'" box'),{code:q};r=l,l=s.readUint64(),o+=8}else if(l===0){if(e)l=e;else if(d!=="mdat")return u.error("BoxParser","Unlimited box size not supported for type: '"+d+"'"),i=new c(l),i.type=d,{code:v,box:i,size:i.size}}if(l!==0&&l<o)return u.error("BoxParser","Box of type "+d+" has an invalid size "+l+" (too small to be a box)"),{code:q,type:d,size:l,hdr_size:o,start:n};if(l!==0&&e&&l>e)return u.error("BoxParser","Box of type '"+d+"' has a size "+l+" greater than its container size "+e),{code:q,type:d,size:l,hdr_size:o,start:n};if(l!==0&&n+l>s.getEndPosition())return s.seek(n),u.info("BoxParser","Not enough data in stream to parse the entire '"+d+"' box"),{code:q,type:d,size:l,hdr_size:o,start:n,original_size:r};if(t)return{code:v,type:d,size:l,hdr_size:o,start:n};d in M.box?i=new M.box[d](l):d!=="uuid"?(u.warn("BoxParser",`Unknown box type: '${d}'`),i=new c(l),i.type=d,i.has_unparsed_data=!0):a in M.uuid?i=new M.uuid[a](l):(u.warn("BoxParser",`Unknown UUID box type: '${a}'`),i=new c(l),i.type=d,i.uuid=a,i.has_unparsed_data=!0),i.original_size=r,i.hdr_size=o,i.start=n,i.write===c.prototype.write&&i.type!=="mdat"&&(u.info("BoxParser","'"+p+"' box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(s)),i.parse(s);let h=s.getPosition()-(i.start+i.size);return h<0?(u.warn("BoxParser","Parsing of box '"+p+"' did not read the entire indicated box data size (missing "+-h+" bytes), seeking forward"),s.seek(i.start+i.size)):h>0&&i.size!==0&&(u.error("BoxParser","Parsing of box '"+p+"' read "+h+" more bytes than the indicated box data size, seeking backwards"),s.seek(i.start+i.size)),{code:v,box:i,size:i.size}}var x=class extends c{write(t){if(this.size=0,this.writeHeader(t),this.boxes)for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}print(t){this.printHeader(t);for(let e=0;e<this.boxes.length;e++)if(this.boxes[e]){let i=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=i}}parse(t){let e;for(;t.getPosition()<this.start+this.size;)if(e=I(t,!1,this.size-(t.getPosition()-this.start)),e.code===v){let i=e.box;if(this.boxes||(this.boxes=[]),this.boxes.push(i),this.subBoxNames&&this.subBoxNames.indexOf(i.type)!==-1){let r=this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s";this[r]||(this[r]=[]),this[r].push(i)}else{let r=i.type!=="uuid"?i.type:i.uuid;this[r]?u.warn("ContainerBox",`Box of type ${r} already exists in container box ${this.type}.`):this[r]=i}}else return}};var C=class extends x{constructor(e,i,r){super(e);this.hdr_size=i;this.start=r}isVideo(){return!1}isAudio(){return!1}isSubtitle(){return!1}isMetadata(){return!1}isHint(){return!1}getCodec(){return this.type.replace(".","")}getWidth(){return""}getHeight(){return""}getChannelCount(){return""}getSampleRate(){return""}getSampleSize(){return""}parseHeader(e){e.readUint8Array(6),this.data_reference_index=e.readUint16(),this.hdr_size+=8}parse(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)}parseDataAndRewind(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,e.seek(this.start+this.hdr_size)}parseFooter(e){super.parse(e)}writeHeader(e){this.size=8,super.writeHeader(e),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint16(this.data_reference_index)}writeFooter(e){if(this.boxes)for(let i=0;i<this.boxes.length;i++)this.boxes[i].write(e),this.size+=this.boxes[i].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}write(e){this.writeHeader(e),e.writeUint8Array(this.data),this.size+=this.data.length,u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}};C.registryId=Symbol.for("SampleEntryIdentifier");var be=class extends C{},N=class extends C{isMetadata(){return!0}},D=class extends C{isSubtitle(){return!0}},ot=class extends C{},B=class extends C{parse(t){this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16();let e=Math.min(31,t.readUint8());this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}isVideo(){return!0}getWidth(){return this.width}getHeight(){return this.height}write(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)}},k=class extends C{parse(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}isAudio(){return!0}getChannelCount(){return this.channel_count}getSampleRate(){return this.samplerate}getSampleSize(){return this.samplesize}write(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)}},X=class extends C{parse(t){this.parseHeader(t),this.parseFooter(t)}write(t){this.writeHeader(t),this.writeFooter(t)}};var xe=class extends c{constructor(){super(...arguments);this.box_name="AVCConfigurationBox"}parse(e){this.configurationVersion=e.readUint8(),this.AVCProfileIndication=e.readUint8(),this.profile_compatibility=e.readUint8(),this.AVCLevelIndication=e.readUint8(),this.lengthSizeMinusOne=e.readUint8()&3,this.nb_SPS_nalus=e.readUint8()&31;let i=this.size-this.hdr_size-6;this.SPS=[];for(let r=0;r<this.nb_SPS_nalus;r++){let n=e.readUint16();this.SPS[r]={length:n,data:e.readUint8Array(n)},i-=2+n}this.nb_PPS_nalus=e.readUint8(),i--,this.PPS=[];for(let r=0;r<this.nb_PPS_nalus;r++){let n=e.readUint16();this.PPS[r]={length:n,data:e.readUint8Array(n)},i-=2+n}i>0&&(this.ext=e.readUint8Array(i))}write(e){this.size=7;for(let i=0;i<this.SPS.length;i++)this.size+=2+this.SPS[i].length;for(let i=0;i<this.PPS.length;i++)this.size+=2+this.PPS[i].length;this.ext&&(this.size+=this.ext.length),this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8(this.AVCProfileIndication),e.writeUint8(this.profile_compatibility),e.writeUint8(this.AVCLevelIndication),e.writeUint8(this.lengthSizeMinusOne+252),e.writeUint8(this.SPS.length+224);for(let i=0;i<this.SPS.length;i++)e.writeUint16(this.SPS[i].length),e.writeUint8Array(this.SPS[i].data);e.writeUint8(this.PPS.length);for(let i=0;i<this.PPS.length;i++)e.writeUint16(this.PPS[i].length),e.writeUint8Array(this.PPS[i].data);this.ext&&e.writeUint8Array(this.ext)}};xe.fourcc="avcC";var J=class extends c{constructor(){super(...arguments);this.box_name="MediaDataBox"}};J.fourcc="mdat";var xt=class extends c{constructor(){super(...arguments);this.box_name="ItemDataBox"}};xt.fourcc="idat";var yt=class extends c{constructor(){super(...arguments);this.box_name="FreeSpaceBox"}};yt.fourcc="free";var gt=class extends c{constructor(){super(...arguments);this.box_name="FreeSpaceBox"}};gt.fourcc="skip";var ye=class extends f{constructor(){super(...arguments);this.box_name="HintMediaHeaderBox"}};ye.fourcc="hmhd";var Q=class extends f{constructor(){super(...arguments);this.box_name="NullMediaHeaderBox"}};Q.fourcc="nmhd";var St=class extends f{constructor(){super(...arguments);this.box_name="ObjectDescriptorBox"}};St.fourcc="iods";var Bt=class extends f{constructor(){super(...arguments);this.box_name="XMLBox"}};Bt.fourcc="xml ";var Ut=class extends f{constructor(){super(...arguments);this.box_name="BinaryXMLBox"}};Ut.fourcc="bxml";var wt=class extends f{constructor(){super(...arguments);this.box_name="ItemProtectionBox";this.sinfs=[]}get protections(){return this.sinfs}};wt.fourcc="ipro";var ne=class extends x{constructor(){super(...arguments);this.box_name="MovieBox";this.traks=[];this.psshs=[];this.subBoxNames=["trak","pssh"]}};ne.fourcc="moov";var ge=class extends x{constructor(){super(...arguments);this.box_name="TrackBox"}};ge.fourcc="trak";var At=class extends x{constructor(){super(...arguments);this.box_name="EditBox"}};At.fourcc="edts";var Se=class extends x{constructor(){super(...arguments);this.box_name="MediaBox"}};Se.fourcc="mdia";var Be=class extends x{constructor(){super(...arguments);this.box_name="MediaInformationBox"}};Be.fourcc="minf";var Ue=class extends x{constructor(){super(...arguments);this.box_name="DataInformationBox"}};Ue.fourcc="dinf";var we=class extends x{constructor(){super(...arguments);this.box_name="SampleTableBox";this.sgpds=[];this.sbgps=[];this.subBoxNames=["sgpd","sbgp"]}};we.fourcc="stbl";var oe=class extends x{constructor(){super(...arguments);this.box_name="MovieExtendsBox";this.trexs=[];this.subBoxNames=["trex"]}};oe.fourcc="mvex";var Ae=class extends x{constructor(){super(...arguments);this.box_name="MovieFragmentBox";this.trafs=[];this.subBoxNames=["traf"]}};Ae.fourcc="moof";var ve=class extends x{constructor(){super(...arguments);this.box_name="TrackFragmentBox";this.truns=[];this.sgpds=[];this.sbgps=[];this.subBoxNames=["trun","sgpd","sbgp"]}};ve.fourcc="traf";var vt=class extends x{constructor(){super(...arguments);this.box_name="VTTCueBox"}};vt.fourcc="vttc";var Mt=class extends x{constructor(){super(...arguments);this.box_name="MovieFragmentRandomAccessBox";this.tfras=[];this.subBoxNames=["tfra"]}};Mt.fourcc="mfra";var It=class extends x{constructor(){super(...arguments);this.box_name="AdditionalMetadataContainerBox"}};It.fourcc="meco";var zt=class extends x{constructor(){super(...arguments);this.box_name="trackhintinformation";this.subBoxNames=["sdp ","rtp "]}};zt.fourcc="hnti";var kt=class extends x{constructor(){super(...arguments);this.box_name="hintstatisticsbox";this.maxrs=[];this.subBoxNames=["maxr"]}};kt.fourcc="hinf";var Tt=class extends x{constructor(){super(...arguments);this.box_name="SubTrackBox"}};Tt.fourcc="strk";var Ft=class extends x{constructor(){super(...arguments);this.box_name="SubTrackDefinitionBox"}};Ft.fourcc="strd";var Et=class extends x{constructor(){super(...arguments);this.box_name="ProtectionSchemeInfoBox"}};Et.fourcc="sinf";var Dt=class extends x{constructor(){super(...arguments);this.box_name="RestrictedSchemeInfoBox"}};Dt.fourcc="rinf";var Pt=class extends x{constructor(){super(...arguments);this.box_name="SchemeInformationBox"}};Pt.fourcc="schi";var Lt=class extends x{constructor(){super(...arguments);this.box_name="TrackGroupBox"}};Lt.fourcc="trgr";var Ct=class extends x{constructor(){super(...arguments);this.box_name="UserDataBox";this.kinds=[];this.strks=[];this.subBoxNames=["kind","strk"]}};Ct.fourcc="udta";var Nt=class extends x{constructor(){super(...arguments);this.box_name="ItemPropertiesBox";this.ipmas=[];this.subBoxNames=["ipma"]}};Nt.fourcc="iprp";var Rt=class extends x{constructor(){super(...arguments);this.box_name="ItemPropertyContainerBox";this.hvcCs=[];this.ispes=[];this.claps=[];this.irots=[];this.subBoxNames=["hvcC","ispe","clap","irot"]}};Rt.fourcc="ipco";var Ot=class extends x{constructor(){super(...arguments);this.box_name="GroupsListBox"}};Ot.fourcc="grpl";var Ht=class extends x{constructor(){super(...arguments);this.box_name="J2KHeaderInfoBox"}};Ht.fourcc="j2kH";var Vt=class extends x{constructor(){super(...arguments);this.box_name="ExtendedTypeBox";this.tycos=[];this.subBoxNames=["tyco"]}};Vt.fourcc="etyp";var Me=class extends f{constructor(){super(...arguments);this.box_name="DataReferenceBox"}parse(e){this.parseFullHeader(e),this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++){let n=I(e,!1,this.size-(e.getPosition()-this.start));if(n.code===v){let o=n.box;this.entries.push(o)}else return}}write(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++)this.entries[i].write(e),this.size+=this.entries[i].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}};Me.fourcc="dref";var Ie=class extends f{constructor(){super(...arguments);this.box_name="ExtendedLanguageBox"}parse(e){this.parseFullHeader(e),this.extended_language=e.readString(this.size-this.hdr_size)}write(e){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(e),e.writeString(this.extended_language)}};Ie.fourcc="elng";var ze=class extends c{constructor(){super(...arguments);this.box_name="FileTypeBox"}parse(e){let i=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),i-=8,this.compatible_brands=[];let r=0;for(;i>=4;)this.compatible_brands[r]=e.readString(4),i-=4,r++}write(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,null,4),e.writeUint32(this.minor_version);for(let i=0;i<this.compatible_brands.length;i++)e.writeString(this.compatible_brands[i],null,4)}};ze.fourcc="ftyp";var ke=class extends f{constructor(){super(...arguments);this.box_name="HandlerBox"}parse(e){this.parseFullHeader(e),this.version===0&&(e.readUint32(),this.handler=e.readString(4),e.readUint32Array(3),this.isEndOfBox(e)||(this.name=e.readCString()))}write(e){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(e),e.writeUint32(0),e.writeString(this.handler,null,4),e.writeUint32Array([0,0,0]),e.writeCString(this.name)}};ke.fourcc="hdlr";var Te=class extends c{constructor(){super(...arguments);this.box_name="HEVCConfigurationBox"}parse(e){this.configurationVersion=e.readUint8();let i=e.readUint8();this.general_profile_space=i>>6,this.general_tier_flag=(i&32)>>5,this.general_profile_idc=i&31,this.general_profile_compatibility=e.readUint32(),this.general_constraint_indicator=e.readUint8Array(6),this.general_level_idc=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3,this.chroma_format_idc=e.readUint8()&3,this.bit_depth_luma_minus8=e.readUint8()&7,this.bit_depth_chroma_minus8=e.readUint8()&7,this.avgFrameRate=e.readUint16(),i=e.readUint8(),this.constantFrameRate=i>>6,this.numTemporalLayers=(i&13)>>3,this.temporalIdNested=(i&4)>>2,this.lengthSizeMinusOne=i&3,this.nalu_arrays=[];let r=e.readUint8();for(let n=0;n<r;n++){let o=[];this.nalu_arrays.push(o),i=e.readUint8(),o.completeness=(i&128)>>7,o.nalu_type=i&63;let a=e.readUint16();for(let l=0;l<a;l++){let d=e.readUint16();o.push({data:e.readUint8Array(d)})}}}write(e){this.size=23;for(let i=0;i<this.nalu_arrays.length;i++){this.size+=3;for(let r=0;r<this.nalu_arrays[i].length;r++)this.size+=2+this.nalu_arrays[i][r].data.length}this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),e.writeUint32(this.general_profile_compatibility),e.writeUint8Array(this.general_constraint_indicator),e.writeUint8(this.general_level_idc),e.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),e.writeUint8(this.parallelismType+252),e.writeUint8(this.chroma_format_idc+252),e.writeUint8(this.bit_depth_luma_minus8+248),e.writeUint8(this.bit_depth_chroma_minus8+248),e.writeUint16(this.avgFrameRate),e.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),e.writeUint8(this.nalu_arrays.length);for(let i=0;i<this.nalu_arrays.length;i++){e.writeUint8((this.nalu_arrays[i].completeness<<7)+this.nalu_arrays[i].nalu_type),e.writeUint16(this.nalu_arrays[i].length);for(let r=0;r<this.nalu_arrays[i].length;r++)e.writeUint16(this.nalu_arrays[i][r].data.length),e.writeUint8Array(this.nalu_arrays[i][r].data)}}};Te.fourcc="hvcC";var Fe=class extends f{constructor(){super(...arguments);this.box_name="MediaHeaderBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.parseLanguage(e),e.readUint16()}write(e){let i=this.modification_time>w||this.creation_time>w||this.duration>w||this.version===1;this.version=i?1:0,this.size=4*4+2*2,this.size+=i?3*4:0,this.flags=0,this.writeHeader(e),i?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.timescale),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration)),e.writeUint16(this.language),e.writeUint16(0)}};Fe.fourcc="mdhd";var Ee=class extends f{constructor(){super(...arguments);this.box_name="MovieExtendsHeaderBox"}parse(e){this.parseFullHeader(e),this.flags&1&&(u.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version===1?this.fragment_duration=e.readUint64():this.fragment_duration=e.readUint32()}write(e){let i=this.fragment_duration>w||this.version===1;this.version=i?1:0,this.size=4,this.size+=i?4:0,this.flags=0,this.writeHeader(e),i?e.writeUint64(this.fragment_duration):e.writeUint32(this.fragment_duration)}};Ee.fourcc="mehd";var Gt=class extends f{constructor(){super(...arguments);this.box_name="ItemInfoEntry"}parse(e){if(this.parseFullHeader(e),(this.version===0||this.version===1)&&(this.item_ID=e.readUint16(),this.item_protection_index=e.readUint16(),this.item_name=e.readCString(),this.content_type=e.readCString(),this.isEndOfBox(e)||(this.content_encoding=e.readCString())),this.version===1){this.extension_type=e.readString(4),u.warn("BoxParser","Cannot parse extension type"),e.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=e.readUint16():this.version===3&&(this.item_ID=e.readUint32()),this.item_protection_index=e.readUint16(),this.item_type=e.readString(4),this.item_name=e.readCString(),this.item_type==="mime"?(this.content_type=e.readCString(),this.content_encoding=e.readCString()):this.item_type==="uri "&&(this.item_uri_type=e.readCString()))}};Gt.fourcc="infe";var jt=class extends f{constructor(){super(...arguments);this.box_name="ItemInfoBox"}parse(e){this.parseFullHeader(e),this.version===0?this.entry_count=e.readUint16():this.entry_count=e.readUint32(),this.item_infos=[];for(let i=0;i<this.entry_count;i++){let r=I(e,!1,this.size-(e.getPosition()-this.start));if(r.code===v){let n=r.box;n.type==="infe"?this.item_infos[i]=n:u.error("BoxParser","Expected 'infe' box, got "+r.box.type)}else return}}};jt.fourcc="iinf";var Kt=class extends f{constructor(){super(...arguments);this.box_name="ItemLocationBox"}parse(e){this.parseFullHeader(e);let i;i=e.readUint8(),this.offset_size=i>>4&15,this.length_size=i&15,i=e.readUint8(),this.base_offset_size=i>>4&15,this.version===1||this.version===2?this.index_size=i&15:this.index_size=0,this.items=[];let r=0;if(this.version<2)r=e.readUint16();else if(this.version===2)r=e.readUint32();else throw new Error("version of iloc box not supported");for(let n=0;n<r;n++){let o=0,a=0,l=0;if(this.version<2)o=e.readUint16();else if(this.version===2)o=e.readUint32();else throw new Error("version of iloc box not supported");this.version===1||this.version===2?a=e.readUint16()&15:a=0;let d=e.readUint16();switch(this.base_offset_size){case 0:l=0;break;case 4:l=e.readUint32();break;case 8:l=e.readUint64();break;default:throw new Error("Error reading base offset size")}let p=[],h=e.readUint16();for(let m=0;m<h;m++){let _=0,U=0,S=0;if(this.version===1||this.version===2)switch(this.index_size){case 0:_=0;break;case 4:_=e.readUint32();break;case 8:_=e.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.offset_size){case 0:U=0;break;case 4:U=e.readUint32();break;case 8:U=e.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.length_size){case 0:S=0;break;case 4:S=e.readUint32();break;case 8:S=e.readUint64();break;default:throw new Error("Error reading extent index")}p.push({extent_index:_,extent_length:S,extent_offset:U})}this.items.push({base_offset:l,construction_method:a,item_ID:o,data_reference_index:d,extents:p})}}};Kt.fourcc="iloc";var ko={auxl:"Auxiliary image item",base:"Pre-derived image item base",cdsc:"Item describes referenced item",dimg:"Derived image item",dpnd:"Item coding dependency",eroi:"Region",evir:"EVC slice",exbl:"Scalable image item","fdl ":"File delivery",font:"Font item",iloc:"Item data location",mask:"Region mask",mint:"Data integrity",pred:"Predictively coded item",prem:"Pre-multiplied item",tbas:"HEVC tile track base item",thmb:"Thumbnail image item"},at=class at extends f{constructor(){super(...arguments);this.box_name="ItemReferenceBox";this.references=[]}parse(e){for(this.parseFullHeader(e),this.references=[];e.getPosition()<this.start+this.size;){let i=I(e,!0,this.size-(e.getPosition()-this.start));if(i.code===v){let r="Unknown item reference";at.allowed_types.includes(i.type)?r=ko[i.type]:u.warn("BoxParser",`Unknown item reference type: '${i.type}'`);let n=this.version===0?new it(i.type,i.size,r,i.hdr_size,i.start):new rt(i.type,i.size,r,i.hdr_size,i.start);n.write===c.prototype.write&&n.type!=="mdat"&&(u.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(e)),n.parse(e),this.references.push(n)}else return}}};at.fourcc="iref",at.allowed_types=["auxl","base","cdsc","dimg","dpnd","eroi","evir","exbl","fdl ","font","iloc","mask","mint","pred","prem","tbas","thmb"];var Kn=at;var qt=class extends f{constructor(){super(...arguments);this.box_name="PrimaryItemBox"}parse(e){this.parseFullHeader(e),this.version===0?this.item_id=e.readUint16():this.item_id=e.readUint32()}};qt.fourcc="pitm";var Yt=class extends f{constructor(){super(...arguments);this.box_name="MetaBox"}parse(e){this.parseFullHeader(e),this.boxes=[],x.prototype.parse.call(this,e)}};Yt.fourcc="meta";var De=class extends f{constructor(){super(...arguments);this.box_name="MovieFragmentHeaderBox"}parse(e){this.parseFullHeader(e),this.sequence_number=e.readUint32()}write(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.sequence_number)}};De.fourcc="mfhd";var Pe=class extends f{constructor(){super(...arguments);this.box_name="MovieHeaderBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.rate=e.readUint32(),this.volume=e.readUint16()>>8,e.readUint16(),e.readUint32Array(2),this.matrix=e.readUint32Array(9),e.readUint32Array(6),this.next_track_id=e.readUint32()}write(e){let i=this.modification_time>w||this.creation_time>w||this.duration>w||this.version===1;this.version=i?1:0,this.size=4*4+20*4,this.size+=i?3*4:0,this.flags=0,this.writeHeader(e),i?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.timescale),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration)),e.writeUint32(this.rate),e.writeUint16(this.volume<<8),e.writeUint16(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32Array(this.matrix),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(this.next_track_id)}print(e){super.printHeader(e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"timescale: "+this.timescale),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"rate: "+this.rate),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"next_track_id: "+this.next_track_id)}};Pe.fourcc="mvhd";var $t=class extends N{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}};$t.fourcc="mett";var Wt=class extends N{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}};Wt.fourcc="metx";var Zt=class extends c{constructor(){super(...arguments);this.box_name="AV1CodecConfigurationBox"}parse(e){let i=e.readUint8();if((i>>7&1)!==1){u.error("av1C marker problem");return}if(this.version=i&127,this.version!==1){u.error("av1C version "+this.version+" not supported");return}if(i=e.readUint8(),this.seq_profile=i>>5&7,this.seq_level_idx_0=i&31,i=e.readUint8(),this.seq_tier_0=i>>7&1,this.high_bitdepth=i>>6&1,this.twelve_bit=i>>5&1,this.monochrome=i>>4&1,this.chroma_subsampling_x=i>>3&1,this.chroma_subsampling_y=i>>2&1,this.chroma_sample_position=i&3,i=e.readUint8(),this.reserved_1=i>>5&7,this.reserved_1!==0){u.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=i>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=i&15;else if(this.reserved_2=i&15,this.reserved_2!==0){u.error("av1C reserved_2 parsing problem");return}let r=this.size-this.hdr_size-4;this.configOBUs=e.readUint8Array(r)}};Zt.fourcc="av1C";var Xt=class extends f{constructor(){super(...arguments);this.box_name="ElementaryStreamDescriptorBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8Array(this.size-this.hdr_size);if("MPEG4DescriptorParser"in bt){let r=new bt.MPEG4DescriptorParser;this.esd=r.parseOneDescriptor(new E(i.buffer,0,1))}}};Xt.fourcc="esds";var Jt=class extends f{constructor(){super(...arguments);this.box_name="VPCodecConfigurationRecord"}parse(e){if(this.parseFullHeader(e),this.version===1){this.profile=e.readUint8(),this.level=e.readUint8();let i=e.readUint8();this.bitDepth=i>>4,this.chromaSubsampling=i>>1&7,this.videoFullRangeFlag=i&1,this.colourPrimaries=e.readUint8(),this.transferCharacteristics=e.readUint8(),this.matrixCoefficients=e.readUint8(),this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)}else{this.profile=e.readUint8(),this.level=e.readUint8();let i=e.readUint8();this.bitDepth=i>>4&15,this.colorSpace=i&15,i=e.readUint8(),this.chromaSubsampling=i>>4&15,this.transferFunction=i>>1&7,this.videoFullRangeFlag=i&1,this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)}}};Jt.fourcc="vpcC";var Qt=class extends f{constructor(){super(...arguments);this.box_name="VvcConfigurationBox"}parse(e){this.parseFullHeader(e);let i={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(a){this.held_bits=a.readUint8(),this.num_held_bits=1*8},stream_read_2_bytes:function(a){this.held_bits=a.readUint16(),this.num_held_bits=2*8},extract_bits:function(a){let l=this.held_bits>>this.num_held_bits-a&(1<<a)-1;return this.num_held_bits-=a,l}};if(i.stream_read_1_bytes(e),i.extract_bits(5),this.lengthSizeMinusOne=i.extract_bits(2),this.ptl_present_flag=i.extract_bits(1),this.ptl_present_flag){i.stream_read_2_bytes(e),this.ols_idx=i.extract_bits(9),this.num_sublayers=i.extract_bits(3),this.constant_frame_rate=i.extract_bits(2),this.chroma_format_idc=i.extract_bits(2),i.stream_read_1_bytes(e),this.bit_depth_minus8=i.extract_bits(3),i.extract_bits(5);{if(i.stream_read_2_bytes(e),i.extract_bits(2),this.num_bytes_constraint_info=i.extract_bits(6),this.general_profile_idc=i.extract_bits(7),this.general_tier_flag=i.extract_bits(1),this.general_level_idc=e.readUint8(),i.stream_read_1_bytes(e),this.ptl_frame_only_constraint_flag=i.extract_bits(1),this.ptl_multilayer_enabled_flag=i.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(let a=0;a<this.num_bytes_constraint_info-1;a++){let l=i.extract_bits(6);i.stream_read_1_bytes(e);let d=i.extract_bits(2);this.general_constraint_info[a]=l<<2|d}this.general_constraint_info[this.num_bytes_constraint_info-1]=i.extract_bits(6)}else i.extract_bits(6);if(this.num_sublayers>1){i.stream_read_1_bytes(e),this.ptl_sublayer_present_mask=0;for(let a=this.num_sublayers-2;a>=0;--a){let l=i.extract_bits(1);this.ptl_sublayer_present_mask|=l<<a}for(let a=this.num_sublayers;a<=8&&this.num_sublayers>1;++a)i.extract_bits(1);this.sublayer_level_idc=[];for(let a=this.num_sublayers-2;a>=0;--a)this.ptl_sublayer_present_mask&1<<a&&(this.sublayer_level_idc[a]=e.readUint8())}if(this.ptl_num_sub_profiles=e.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(let a=0;a<this.ptl_num_sub_profiles;a++)this.general_sub_profile_idc.push(e.readUint32())}this.max_picture_width=e.readUint16(),this.max_picture_height=e.readUint16(),this.avg_frame_rate=e.readUint16()}let r=12,n=13;this.nalu_arrays=[];let o=e.readUint8();for(let a=0;a<o;a++){let l=[];this.nalu_arrays.push(l),i.stream_read_1_bytes(e),l.completeness=i.extract_bits(1),i.extract_bits(2),l.nalu_type=i.extract_bits(5);let d=1;l.nalu_type!==n&&l.nalu_type!==r&&(d=e.readUint16());for(let p=0;p<d;p++){let h=e.readUint16();l.push({data:e.readUint8Array(h),length:h})}}}};Qt.fourcc="vvcC";var ei=class extends c{constructor(){super(...arguments);this.box_name="ColourInformationBox"}parse(e){if(this.colour_type=e.readString(4),this.colour_type==="nclx"){this.colour_primaries=e.readUint16(),this.transfer_characteristics=e.readUint16(),this.matrix_coefficients=e.readUint16();let i=e.readUint8();this.full_range_flag=i>>7}else this.colour_type==="rICC"?this.ICC_profile=e.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=e.readUint8Array(this.size-4))}};ei.fourcc="colr";function Le(s,t){let e=Number(s).toString(16);for(t=typeof t=="undefined"||t===null?t=2:t;e.length<t;)e="0"+e;return e}var Ce=class extends B{getCodec(){let t=super.getCodec();return this.avcC?`${t}.${Le(this.avcC.AVCProfileIndication)}${Le(this.avcC.profile_compatibility)}${Le(this.avcC.AVCLevelIndication)}`:t}},ti=class extends Ce{};ti.fourcc="avc1";var ii=class extends Ce{};ii.fourcc="avc2";var ri=class extends Ce{};ri.fourcc="avc3";var si=class extends Ce{};si.fourcc="avc4";var ni=class extends B{getCodec(){let t=super.getCodec(),e=this.av1C.seq_level_idx_0,i=e<10?"0"+e:e,r;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?r=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(r=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+i+(this.av1C.seq_tier_0?"H":"M")+"."+r}};ni.fourcc="av01";var oi=class extends B{};oi.fourcc="dav1";var Ne=class extends B{getCodec(){let t=super.getCodec();if(this.hvcC){switch(t+=".",this.hvcC.general_profile_space){case 0:t+="";break;case 1:t+="A";break;case 2:t+="B";break;case 3:t+="C";break}t+=this.hvcC.general_profile_idc,t+=".";let e=this.hvcC.general_profile_compatibility,i=0;for(let o=0;o<32&&(i|=e&1,o!==31);o++)i<<=1,e>>=1;t+=Le(i,0),t+=".",this.hvcC.general_tier_flag===0?t+="L":t+="H",t+=this.hvcC.general_level_idc;let r=!1,n="";for(let o=5;o>=0;o--)(this.hvcC.general_constraint_indicator[o]||r)&&(n="."+Le(this.hvcC.general_constraint_indicator[o],0)+n,r=!0);t+=n}return t}},ai=class extends Ne{};ai.fourcc="hvc1";var fi=class extends Ne{};fi.fourcc="hvc2";var li=class extends Ne{constructor(){super(...arguments);this.colrs=[];this.subBoxNames=["colr"]}};li.fourcc="hev1";var di=class extends Ne{};di.fourcc="hev2";var ui=class extends B{};ui.fourcc="hvt1";var ci=class extends B{};ci.fourcc="lhe1";var pi=class extends B{};pi.fourcc="lhv1";var mi=class extends B{};mi.fourcc="dvh1";var hi=class extends B{};hi.fourcc="dvhe";var Yi=class extends B{getCodec(){let t=super.getCodec();if(this.vvcC){t+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?t+=".H":t+=".L",t+=this.vvcC.general_level_idc;let e="";if(this.vvcC.general_constraint_info){let i=[],r=0;r|=this.vvcC.ptl_frame_only_constraint_flag<<7,r|=this.vvcC.ptl_multilayer_enabled_flag<<6;let n;for(let o=0;o<this.vvcC.general_constraint_info.length;++o)r|=this.vvcC.general_constraint_info[o]>>2&63,i.push(r),r&&(n=o),r=this.vvcC.general_constraint_info[o]>>2&3;if(n===void 0)e=".CA";else{e=".C";let o="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",a=0,l=0;for(let d=0;d<=n;++d)for(a=a<<8|i[d],l+=8;l>=5;){let p=a>>l-5&31;e+=o[p],l-=5,a&=(1<<l)-1}l&&(a<<=5-l,e+=o[a&31])}}t+=e}return t}},_i=class extends Yi{};_i.fourcc="vvc1";var bi=class extends Yi{};bi.fourcc="vvi1";var xi=class extends B{};xi.fourcc="vvs1";var yi=class extends B{};yi.fourcc="vvcN";var $i=class extends B{getCodec(){let t=super.getCodec(),e=this.vpcC.level;e===0&&(e="00");let i=this.vpcC.bitDepth;return i===8&&(i="08"),`${t}.0${this.vpcC.profile}.${e}.${i}`}},gi=class extends $i{};gi.fourcc="vp08";var Si=class extends $i{};Si.fourcc="vp09";var Bi=class extends B{};Bi.fourcc="avs3";var Ui=class extends B{};Ui.fourcc="j2ki";var wi=class extends B{};wi.fourcc="mjp2";var Ai=class extends B{};Ai.fourcc="mjpg";var vi=class extends B{};vi.fourcc="uncv";var Mi=class extends B{};Mi.fourcc="mp4v";var Ii=class extends k{getCodec(){let t=super.getCodec();if(this.esds&&this.esds.esd){let e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+Le(e)+(i?"."+i:"")}else return t}};Ii.fourcc="mp4a";var zi=class extends k{};zi.fourcc="m4ae";var ki=class extends k{};ki.fourcc="ac-3";var Ti=class extends k{};Ti.fourcc="ac-4";var Fi=class extends k{};Fi.fourcc="ec-3";var Ei=class extends k{};Ei.fourcc="Opus";var Di=class extends k{};Di.fourcc="mha1";var Pi=class extends k{};Pi.fourcc="mha2";var Li=class extends k{};Li.fourcc="mhm1";var Ci=class extends k{};Ci.fourcc="mhm2";var Ni=class extends k{};Ni.fourcc="fLaC";var Ri=class extends B{};Ri.fourcc="encv";var Oi=class extends k{};Oi.fourcc="enca";var Hi=class extends D{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};Hi.fourcc="encu";var Vi=class extends X{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};Vi.fourcc="encs";var Gi=class extends X{};Gi.fourcc="mp4s";var ji=class extends ot{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};ji.fourcc="enct";var Ki=class extends N{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};Ki.fourcc="encm";var qi=class extends B{};qi.fourcc="resv";var Wi=class extends D{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}};Wi.fourcc="sbtt";var Re=class extends D{parse(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}write(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)}};Re.fourcc="stpp";var Zi=class extends D{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}getCodec(){let t=super.getCodec();return this.mime_format?t+"."+this.mime_format:t}};Zi.fourcc="stxt";var Xi=class extends D{parse(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}};Xi.fourcc="tx3g";var Ji=class extends N{parse(t){this.parseHeader(t),this.parseFooter(t)}};Ji.fourcc="wvtt";var Qi=class extends f{constructor(){super(...arguments);this.box_name="SampleToGroupBox"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readString(4),this.version===1?this.grouping_type_parameter=e.readUint32():this.grouping_type_parameter=0,this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++)this.entries.push({sample_count:e.readInt32(),group_description_index:e.readInt32()})}write(e){this.grouping_type_parameter?this.version=1:this.version=0,this.flags=0,this.size=8+8*this.entries.length+(this.version===1?4:0),this.writeHeader(e),e.writeString(this.grouping_type,null,4),this.version===1&&e.writeUint32(this.grouping_type_parameter),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++){let r=this.entries[i];e.writeInt32(r.sample_count),e.writeInt32(r.group_description_index)}}};Qi.fourcc="sbgp";var er=class extends f{constructor(){super(...arguments);this.box_name="SampleDependencyTypeBox"}parse(e){this.parseFullHeader(e);let i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(let r=0;r<i;r++){let n=e.readUint8();this.is_leading[r]=n>>6,this.sample_depends_on[r]=n>>4&3,this.sample_is_depended_on[r]=n>>2&3,this.sample_has_redundancy[r]=n&3}}};er.fourcc="sdtp";var tr=class extends f{constructor(){super(...arguments);this.box_name="SampleGroupDescriptionBox"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readString(4),u.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=e.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=e.readUint32()),this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++){let n;this.grouping_type in M.sampleGroupEntry?n=new M.sampleGroupEntry[this.grouping_type](this.grouping_type):n=new b(this.grouping_type),this.entries.push(n),this.version===1?this.default_length===0?n.description_length=e.readUint32():n.description_length=this.default_length:n.description_length=this.default_length,n.write===b.prototype.write&&(u.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),n.data=e.readUint8Array(n.description_length),e.seek(e.getPosition()-n.description_length)),n.parse(e)}}write(e){this.flags=0,this.size=12;for(let i=0;i<this.entries.length;i++){let r=this.entries[i];this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=r.data.length)}this.writeHeader(e),e.writeString(this.grouping_type,null,4),this.version===1&&e.writeUint32(this.default_length),this.version>=2&&e.writeUint32(this.default_sample_description_index),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++){let r=this.entries[i];this.version===1&&this.default_length===0&&e.writeUint32(r.description_length),r.write(e)}}};tr.fourcc="sgpd";var ir=class extends f{constructor(){super(...arguments);this.box_name="CompressedSegmentIndexBox"}parse(e){this.parseFullHeader(e),this.reference_ID=e.readUint32(),this.timescale=e.readUint32(),this.version===0?(this.earliest_presentation_time=e.readUint32(),this.first_offset=e.readUint32()):(this.earliest_presentation_time=e.readUint64(),this.first_offset=e.readUint64()),e.readUint16(),this.references=[];let i=e.readUint16();for(let r=0;r<i;r++){let n=e.readUint32(),o=e.readUint32(),a=e.readUint32();this.references.push({reference_type:n>>31&1,referenced_size:n&2147483647,subsegment_duration:o,starts_with_SAP:a>>31&1,SAP_type:a>>28&7,SAP_delta_time:a&268435455})}}write(e){let i=this.earliest_presentation_time>w||this.first_offset>w||this.version===1;this.version=i?1:0,this.size=4*2+2+2+12*this.references.length,this.size+=i?16:8,this.flags=0,this.writeHeader(e),e.writeUint32(this.reference_ID),e.writeUint32(this.timescale),i?(e.writeUint64(this.earliest_presentation_time),e.writeUint64(this.first_offset)):(e.writeUint32(this.earliest_presentation_time),e.writeUint32(this.first_offset)),e.writeUint16(0),e.writeUint16(this.references.length);for(let r=0;r<this.references.length;r++){let n=this.references[r];e.writeUint32(n.reference_type<<31|n.referenced_size),e.writeUint32(n.subsegment_duration),e.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}}};ir.fourcc="sidx";var Oe=class extends f{constructor(){super(...arguments);this.box_name="SoundMediaHeaderBox"}parse(e){this.parseFullHeader(e),this.balance=e.readUint16(),e.readUint16()}write(e){this.version=0,this.size=4,this.writeHeader(e),e.writeUint16(this.balance),e.writeUint16(0)}};Oe.fourcc="smhd";var He=class extends f{constructor(){super(...arguments);this.box_name="ChunkOffsetBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.chunk_offsets=[],this.version===0)for(let r=0;r<i;r++)this.chunk_offsets.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length),e.writeUint32Array(this.chunk_offsets)}unpack(e){for(let i=0;i<this.chunk_offsets.length;i++)e[i].offset=this.chunk_offsets[i]}};He.fourcc="stco";var Ve=class extends f{constructor(){super(...arguments);this.box_name="SubtitleMediaHeaderBox"}};Ve.fourcc="sthd";var Ge=class extends f{constructor(){super(...arguments);this.box_name="SampleToChunkBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(let r=0;r<i;r++)this.first_chunk.push(e.readUint32()),this.samples_per_chunk.push(e.readUint32()),this.sample_description_index.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(e),e.writeUint32(this.first_chunk.length);for(let i=0;i<this.first_chunk.length;i++)e.writeUint32(this.first_chunk[i]),e.writeUint32(this.samples_per_chunk[i]),e.writeUint32(this.sample_description_index[i])}unpack(e){let i=0,r=0;for(let n=0;n<this.first_chunk.length;n++)for(let o=0;o<(n+1<this.first_chunk.length?this.first_chunk[n+1]:1/0);o++){r++;for(let a=0;a<this.samples_per_chunk[n];a++){if(e[i])e[i].description_index=this.sample_description_index[n],e[i].chunk_index=r;else return;i++}}}};Ge.fourcc="stsc";var je=class extends f{constructor(){super(...arguments);this.box_name="SampleDescriptionBox"}parse(e){this.parseFullHeader(e),this.entries=[];let i=e.readUint32();for(let r=1;r<=i;r++){let n=I(e,!0,this.size-(e.getPosition()-this.start));if(n.code===v){let o;n.type in M.sampleEntry?(o=new M.sampleEntry[n.type](n.size),o.hdr_size=n.hdr_size,o.start=n.start):(u.warn("BoxParser",`Unknown sample entry type: '${n.type}'`),o=new C(n.size,n.hdr_size,n.start),o.type=n.type),o.write===C.prototype.write&&(u.info("BoxParser","SampleEntry "+o.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(e)),o.parse(e),this.entries.push(o)}else return}}write(e){this.version=0,this.flags=0,this.size=0,this.writeHeader(e),e.writeUint32(this.entries.length),this.size+=4;for(let i=0;i<this.entries.length;i++)this.entries[i].write(e),this.size+=this.entries[i].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}};je.fourcc="stsd";var Ke=class extends f{constructor(){super(...arguments);this.box_name="SampleSizeBox"}parse(e){if(this.parseFullHeader(e),this.sample_sizes=[],this.version===0){this.sample_size=e.readUint32(),this.sample_count=e.readUint32();for(let i=0;i<this.sample_count;i++)this.sample_size===0?this.sample_sizes.push(e.readUint32()):this.sample_sizes[i]=this.sample_size}}write(e){let i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0){let r=0;for(;r+1<this.sample_sizes.length;)if(this.sample_sizes[r+1]!==this.sample_sizes[0]){i=!1;break}else r++}else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(e),i?e.writeUint32(this.sample_sizes[0]):e.writeUint32(0),e.writeUint32(this.sample_sizes.length),i||e.writeUint32Array(this.sample_sizes)}unpack(e){for(let i=0;i<this.sample_sizes.length;i++)e[i].size=this.sample_sizes[i]}};Ke.fourcc="stsz";var qe=class extends f{constructor(){super(...arguments);this.box_name="TimeToSampleBox";this.sample_counts=[];this.sample_deltas=[]}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.sample_counts.length=0,this.sample_deltas.length=0,this.version===0)for(let r=0;r<i;r++){this.sample_counts.push(e.readUint32());let n=e.readInt32();n<0&&(u.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),n=1),this.sample_deltas.push(n)}}write(e){this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length);for(let i=0;i<this.sample_counts.length;i++)e.writeUint32(this.sample_counts[i]),e.writeUint32(this.sample_deltas[i])}unpack(e){let i=0;for(let r=0;r<this.sample_counts.length;r++)for(let n=0;n<this.sample_counts[r];n++)i===0?e[i].dts=0:e[i].dts=e[i-1].dts+this.sample_deltas[r],i++}};qe.fourcc="stts";var Ye=class extends f{constructor(){super(...arguments);this.box_name="TrackFragmentBaseMediaDecodeTimeBox"}parse(e){this.parseFullHeader(e),this.version===1?this.baseMediaDecodeTime=e.readUint64():this.baseMediaDecodeTime=e.readUint32()}write(e){this.version=this.baseMediaDecodeTime>w||this.version===1?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(e),this.version===1?e.writeUint64(this.baseMediaDecodeTime):e.writeUint32(this.baseMediaDecodeTime)}};Ye.fourcc="tfdt";var $e=class extends f{constructor(){super(...arguments);this.box_name="TrackFragmentHeaderBox"}parse(e){this.parseFullHeader(e);let i=0;this.track_id=e.readUint32(),this.size-this.hdr_size>i&&this.flags&de?(this.base_data_offset=e.readUint64(),i+=8):this.base_data_offset=0,this.size-this.hdr_size>i&&this.flags&ue?(this.default_sample_description_index=e.readUint32(),i+=4):this.default_sample_description_index=0,this.size-this.hdr_size>i&&this.flags&ce?(this.default_sample_duration=e.readUint32(),i+=4):this.default_sample_duration=0,this.size-this.hdr_size>i&&this.flags&pe?(this.default_sample_size=e.readUint32(),i+=4):this.default_sample_size=0,this.size-this.hdr_size>i&&this.flags&me?(this.default_sample_flags=e.readUint32(),i+=4):this.default_sample_flags=0}write(e){this.version=0,this.size=4,this.flags&de&&(this.size+=8),this.flags&ue&&(this.size+=4),this.flags&ce&&(this.size+=4),this.flags&pe&&(this.size+=4),this.flags&me&&(this.size+=4),this.writeHeader(e),e.writeUint32(this.track_id),this.flags&de&&e.writeUint64(this.base_data_offset),this.flags&ue&&e.writeUint32(this.default_sample_description_index),this.flags&ce&&e.writeUint32(this.default_sample_duration),this.flags&pe&&e.writeUint32(this.default_sample_size),this.flags&me&&e.writeUint32(this.default_sample_flags)}};$e.fourcc="tfhd";var We=class extends f{constructor(){super(...arguments);this.box_name="TrackHeaderBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint32()),e.readUint32Array(2),this.layer=e.readInt16(),this.alternate_group=e.readInt16(),this.volume=e.readInt16()>>8,e.readUint16(),this.matrix=e.readInt32Array(9),this.width=e.readUint32(),this.height=e.readUint32()}print(e){super.printHeader(e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"track_id: "+this.track_id),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"layer: "+this.layer),e.log(e.indent+"alternate_group: "+this.alternate_group),e.log(e.indent+"width: "+this.width),e.log(e.indent+"height: "+this.height)}};We.fourcc="tkhd";var ae=class extends f{constructor(){super(...arguments);this.box_name="TrackExtendsBox"}parse(e){this.parseFullHeader(e),this.track_id=e.readUint32(),this.default_sample_description_index=e.readUint32(),this.default_sample_duration=e.readUint32(),this.default_sample_size=e.readUint32(),this.default_sample_flags=e.readUint32()}write(e){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(e),e.writeUint32(this.track_id),e.writeUint32(this.default_sample_description_index),e.writeUint32(this.default_sample_duration),e.writeUint32(this.default_sample_size),e.writeUint32(this.default_sample_flags)}};ae.fourcc="trex";var Ze=class extends f{constructor(){super(...arguments);this.box_name="TrackRunBox"}parse(e){this.parseFullHeader(e);let i=0;if(this.sample_count=e.readUint32(),i+=4,this.size-this.hdr_size>i&&this.flags&ee?(this.data_offset=e.readInt32(),i+=4):this.data_offset=0,this.size-this.hdr_size>i&&this.flags&he?(this.first_sample_flags=e.readUint32(),i+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>i)for(let r=0;r<this.sample_count;r++)this.flags&te&&(this.sample_duration[r]=e.readUint32()),this.flags&ie&&(this.sample_size[r]=e.readUint32()),this.flags&re&&(this.sample_flags[r]=e.readUint32()),this.flags&se&&(this.version===0?this.sample_composition_time_offset[r]=e.readUint32():this.sample_composition_time_offset[r]=e.readInt32())}write(e){this.size=4,this.flags&ee&&(this.size+=4),this.flags&he&&(this.size+=4),this.flags&te&&(this.size+=4*this.sample_duration.length),this.flags&ie&&(this.size+=4*this.sample_size.length),this.flags&re&&(this.size+=4*this.sample_flags.length),this.flags&se&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(e),e.writeUint32(this.sample_count),this.flags&ee&&(this.data_offset_position=e.getPosition(),e.writeInt32(this.data_offset)),this.flags&he&&e.writeUint32(this.first_sample_flags);for(let i=0;i<this.sample_count;i++)this.flags&te&&e.writeUint32(this.sample_duration[i]),this.flags&ie&&e.writeUint32(this.sample_size[i]),this.flags&re&&e.writeUint32(this.sample_flags[i]),this.flags&se&&(this.version===0?e.writeUint32(this.sample_composition_time_offset[i]):e.writeInt32(this.sample_composition_time_offset[i]))}};Ze.fourcc="trun";var Xe=class extends f{constructor(){super(...arguments);this.box_name="DataEntryUrlBox"}parse(e){this.parseFullHeader(e),this.flags!==1&&(this.location=e.readCString())}write(e){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(e),this.location&&e.writeCString(this.location)}};Xe.fourcc="url ";var Je=class extends f{constructor(){super(...arguments);this.box_name="VideoMediaHeaderBox"}parse(e){this.parseFullHeader(e),this.graphicsmode=e.readUint16(),this.opcolor=e.readUint16Array(3)}write(e){this.version=0,this.size=8,this.writeHeader(e),e.writeUint16(this.graphicsmode),e.writeUint16Array(this.opcolor)}};Je.fourcc="vmhd";var Qe=class{constructor(t,e,i){this.grouping_type=t;this.grouping_type_parameter=e;this.sbgp=i;this.last_sample_in_run=-1;this.entry_index=-1}},ft=class s{constructor(t,e=!0){this.boxes=[];this.mdats=[];this.moofs=[];this.isProgressive=!1;this.moovStartFound=!1;this.onMoovStart=null;this.moovStartSent=!1;this.onReady=null;this.readySent=!1;this.onSegment=null;this.onSamples=null;this.onError=null;this.onItem=null;this.sampleListBuilt=!1;this.fragmentedTracks=[];this.extractedTracks=[];this.isFragmentationInitialized=!1;this.sampleProcessingStarted=!1;this.nextMoofNumber=0;this.itemListBuilt=!1;this.onSidx=null;this.sidxSent=!1;this.items=[];this.entity_groups=[];this.itemsDataSize=0;this.lastMoofIndex=0;this.samplesDataSize=0;this.lastBoxStartPosition=0;this.parsingMdat=null;this.nextParsePosition=0;this.discardMdatData=!0;this.discardMdatData=e,t?(this.stream=t,this.parse()):this.stream=new Z}setSegmentOptions(t,e,{nbSamples:i=1e3,rapAlignement:r=!0}={}){let n=this.getTrackById(t);if(n){let o={id:t,user:e,trak:n,segmentStream:null,nb_samples:i,rapAlignement:r};this.fragmentedTracks.push(o),n.nextSample=0}}unsetSegmentOptions(t){let e=-1;for(let i=0;i<this.fragmentedTracks.length;i++)this.fragmentedTracks[i].id===t&&(e=i);e>-1&&this.fragmentedTracks.splice(e,1)}setExtractionOptions(t,e,{nbSamples:i=1e3}={}){let r=this.getTrackById(t);r&&(this.extractedTracks.push({id:t,user:e,trak:r,nb_samples:i,samples:[]}),r.nextSample=0)}unsetExtractionOptions(t){let e=-1;for(let i=0;i<this.extractedTracks.length;i++)this.extractedTracks[i].id===t&&(e=i);e>-1&&this.extractedTracks.splice(e,1)}parse(){if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else{this.saveParsePosition&&this.saveParsePosition();let e=I(this.stream,!1);if(e.code===q)if(this.processIncompleteBox){if(this.processIncompleteBox(e))continue;return}else return;else{let i=e.box;if(this.boxes.push(i),i.type==="uuid")this[i.uuid]!==void 0&&u.warn("ISOFile","Duplicate Box of uuid: "+i.uuid+", overriding previous occurrence"),this[i.uuid]=i;else switch(i.type){case"mdat":this.mdats.push(i),this.transferMdatData(i);break;case"moof":this.moofs.push(i);break;case"free":case"skip":break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[i.type]!==void 0?Array.isArray(this[i.type+"s"])?(u.info("ISOFile",`Found multiple boxes of type ${i.type} in ISOFile, adding to array`),this[i.type+"s"].push(i)):(u.warn("ISOFile",`Found multiple boxes of type ${i.type} but no array exists. Creating array dynamically.`),this[i.type+"s"]=[this[i.type],i]):(this[i.type]=i,Array.isArray(this[i.type+"s"])&&this[i.type+"s"].push(i));break}this.updateUsedBytes&&this.updateUsedBytes(i,e)}}}checkBuffer(t){if(t==null)throw new Error("Buffer must be defined and non empty");return t.byteLength===0?(u.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(u.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(u.warn("ISOFile","Not ready to start parsing"),!1))}appendBuffer(t,e){let i;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(i=this.nextSeekPosition,this.nextSeekPosition=void 0):i=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(i=this.stream.getEndFilePositionAfter(i))):this.nextParsePosition?i=this.nextParsePosition:i=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(u.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+i),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),u.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),i}getInfo(){var r;if(!this.moov)return{hasMoov:!1,mime:""};let t=new Date("1904-01-01T00:00:00Z").getTime(),e=((r=this.moov.mvex)==null?void 0:r.mehd)!==void 0,i={hasMoov:!0,duration:this.moov.mvhd.duration,timescale:this.moov.mvhd.timescale,isFragmented:e,fragment_duration:e?this.moov.mvex.mehd.fragment_duration:void 0,isProgressive:this.isProgressive,hasIOD:this.moov.iods!==null,brands:[this.ftyp.major_brand].concat(this.ftyp.compatible_brands),created:new Date(t+this.moov.mvhd.creation_time*1e3),modified:new Date(t+this.moov.mvhd.modification_time*1e3),tracks:[],audioTracks:[],videoTracks:[],subtitleTracks:[],metadataTracks:[],hintTracks:[],otherTracks:[],mime:""};for(let n=0;n<this.moov.traks.length;n++){let o=this.moov.traks[n],a=o.mdia.minf.stbl.stsd.entries[0],l=o.samples_size,d=o.mdia.mdhd.timescale,p=o.samples_duration,h=l*8*d/p,m={samples_duration:p,bitrate:h,size:l,timescale:d,alternate_group:o.tkhd.alternate_group,codec:a.getCodec(),created:new Date(t+o.tkhd.creation_time*1e3),cts_shift:o.mdia.minf.stbl.cslg,duration:o.mdia.mdhd.duration,id:o.tkhd.track_id,kind:o.udta&&o.udta.kinds.length?o.udta.kinds[0]:{schemeURI:"",value:""},language:o.mdia.elng?o.mdia.elng.extended_language:o.mdia.mdhd.languageString,layer:o.tkhd.layer,matrix:o.tkhd.matrix,modified:new Date(t+o.tkhd.modification_time*1e3),movie_duration:o.tkhd.duration,movie_timescale:i.timescale,name:o.mdia.hdlr.name,nb_samples:o.samples.length,references:[],track_height:o.tkhd.height/65536,track_width:o.tkhd.width/65536,volume:o.tkhd.volume};if(i.tracks.push(m),o.tref)for(let _=0;_<o.tref.references.length;_++)m.references.push({type:o.tref.references[_].type,track_ids:o.tref.references[_].track_ids});o.edts&&(m.edits=o.edts.elst.entries),a instanceof k?(m.type="audio",i.audioTracks.push(m),m.audio={sample_rate:a.getSampleRate(),channel_count:a.getChannelCount(),sample_size:a.getSampleSize()}):a instanceof B?(m.type="video",i.videoTracks.push(m),m.video={width:a.getWidth(),height:a.getHeight()}):a instanceof D?(m.type="subtitles",i.subtitleTracks.push(m)):a instanceof be?(m.type="metadata",i.hintTracks.push(m)):a instanceof N?(m.type="metadata",i.metadataTracks.push(m)):(m.type="metadata",i.otherTracks.push(m))}i.videoTracks&&i.videoTracks.length>0?i.mime+='video/mp4; codecs="':i.audioTracks&&i.audioTracks.length>0?i.mime+='audio/mp4; codecs="':i.mime+='application/mp4; codecs="';for(let n=0;n<i.tracks.length;n++)n!==0&&(i.mime+=","),i.mime+=i.tracks[n].codec;return i.mime+='"; profiles="',i.mime+=this.ftyp.compatible_brands.join(),i.mime+='"',i}setNextSeekPositionFromSample(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)}processSamples(t){if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(let e=0;e<this.fragmentedTracks.length;e++){let i=this.fragmentedTracks[e],r=i.trak;for(;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){u.debug("ISOFile","Creating media fragment on track #"+i.id+" for sample "+r.nextSample);let n=this.createFragment(i.id,r.nextSample,i.segmentStream);if(n)i.segmentStream=n,r.nextSample++;else break;if((r.nextSample%i.nb_samples===0||t||r.nextSample>=r.samples.length)&&(u.info("ISOFile","Sending fragmented data on track #"+i.id+" for samples ["+Math.max(0,r.nextSample-i.nb_samples)+","+(r.nextSample-1)+"]"),u.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(i.id,i.user,i.segmentStream.buffer,r.nextSample,t||r.nextSample>=r.samples.length),i.segmentStream=null,i!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(let e=0;e<this.extractedTracks.length;e++){let i=this.extractedTracks[e],r=i.trak;for(;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){u.debug("ISOFile","Exporting on track #"+i.id+" sample #"+r.nextSample);let n=this.getSample(r,r.nextSample);if(n)r.nextSample++,i.samples.push(n);else{this.setNextSeekPositionFromSample(r.samples[r.nextSample]);break}if((r.nextSample%i.nb_samples===0||r.nextSample>=r.samples.length)&&(u.debug("ISOFile","Sending samples on track #"+i.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(i.id,i.user,i.samples),i.samples=[],i!==this.extractedTracks[e]))break}}}}getBox(t){let e=this.getBoxes(t,!0);return e.length?e[0]:null}getBoxes(t,e){let i=[],r=n=>{n instanceof c&&n.type&&n.type===t&&i.push(n);let o=[];n.boxes&&o.push(...n.boxes),n.entries&&o.push(...n.entries),n.item_infos&&o.push(...n.item_infos),n.references&&o.push(...n.references);for(let a of o){if(i.length&&e)return;r(a)}};return r(this),i}getTrackSamplesInfo(t){let e=this.getTrackById(t);if(e)return e.samples}getTrackSample(t,e){let i=this.getTrackById(t);return this.getSample(i,e)}releaseUsedSamples(t,e){let i=0,r=this.getTrackById(t);r.lastValidSample||(r.lastValidSample=0);for(let n=r.lastValidSample;n<e;n++)i+=this.releaseSample(r,n);u.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+i+", remaining: "+this.samplesDataSize+")"),r.lastValidSample=e}start(){this.sampleProcessingStarted=!0,this.processSamples(!1)}stop(){this.sampleProcessingStarted=!1}flush(){u.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)}seekTrack(t,e,i){let r=0,n=0,o=null;if(i.samples.length===0)return u.info("ISOFile","No sample in track, cannot seek! Using time "+u.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(let l=0;l<i.samples.length;l++){let d=i.samples[l];if(l===0)n=0,o=d.timescale;else if(d.cts>t*d.timescale){n=l-1;break}e&&d.is_sync&&(r=l)}for(e&&(n=r),t=i.samples[n].cts,i.nextSample=n;i.samples[n].alreadyRead===i.samples[n].size&&i.samples[n+1];)n++;let a=i.samples[n].offset+i.samples[n].alreadyRead;return u.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+i.nextSample+" on track "+i.tkhd.track_id+", time "+u.getDurationString(t,o)+" and offset: "+a),{offset:a,time:t/o}}getTrackDuration(t){if(!t.samples)return 1/0;let e=t.samples[t.samples.length-1];return(e.cts+e.duration)/e.timescale}seek(t,e){let i=this.moov,r={offset:1/0,time:1/0};if(this.moov){for(let n=0;n<i.traks.length;n++){let o=i.traks[n];if(t>this.getTrackDuration(o))continue;let a=this.seekTrack(t,e,o);a.offset<r.offset&&(r.offset=a.offset),a.time<r.time&&(r.time=a.time)}return u.info("ISOFile","Seeking at time "+u.getDurationString(r.time,1)+" needs a buffer with a fileStart position of "+r.offset),r.offset===1/0?r={offset:this.nextParsePosition,time:0}:r.offset=this.stream.getEndFilePositionAfter(r.offset),u.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+r.offset),r}else throw new Error("Cannot seek: moov not received!")}equal(t){let e=0;for(;e<this.boxes.length&&e<t.boxes.length;){let i=this.boxes[e],r=t.boxes[e];if(!_t(i,r))return!1;e++}return!0}write(t){for(let e=0;e<this.boxes.length;e++)this.boxes[e].write(t)}createFragment(t,e,i){let r=this.getTrackById(t),n=this.getSample(r,e);if(n===null)return this.setNextSeekPositionFromSample(r.samples[e]),null;let o=i||new E;o.endianness=1;let a=this.createSingleSampleMoof(n);a.write(o),a.trafs[0].truns[0].data_offset=a.size+8,u.debug("MP4Box","Adjusting data_offset with new value "+a.trafs[0].truns[0].data_offset),o.adjustUint32(a.trafs[0].truns[0].data_offset_position,a.trafs[0].truns[0].data_offset);let l=new J;return l.data=n.data,l.write(o),o}static writeInitializationSegment(t,e,i,r){u.debug("ISOFile","Generating initialization segment");let n=new E;n.endianness=1,t.write(n);let o=e.addBox(new oe);if(i){let a=o.addBox(new Ee);a.fragment_duration=i}for(let a=0;a<e.traks.length;a++){let l=o.addBox(new ae);l.track_id=e.traks[a].tkhd.track_id,l.default_sample_description_index=1,l.default_sample_duration=r,l.default_sample_size=0,l.default_sample_flags=65536}return e.write(n),n.buffer}save(t){let e=new E;return e.endianness=1,this.write(e),e.save(t)}getBuffer(){let t=new E;return t.endianness=1,this.write(t),t}initializeSegmentation(){this.onSegment===null&&u.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables());let t=[];for(let e=0;e<this.fragmentedTracks.length;e++){let i=new ne;i.mvhd=this.moov.mvhd,i.addBox(i.mvhd);let r=this.getTrackById(this.fragmentedTracks[e].id);i.addBox(r),i.traks.push(r);let n={id:r.tkhd.track_id,user:this.fragmentedTracks[e].user,buffer:s.writeInitializationSegment(this.ftyp,i,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[e].samples.length>0?this.moov.traks[e].samples[0].duration:0)};t.push(n)}return t}resetTables(){this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0;for(let t=0;t<this.moov.traks.length;t++){let e=this.moov.traks[t];e.tkhd.duration=0,e.mdia.mdhd.duration=0;let i=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64;i.chunk_offsets=[];let r=e.mdia.minf.stbl.stsc;r.first_chunk=[],r.samples_per_chunk=[],r.sample_description_index=[];let n=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2;n.sample_sizes=[];let o=e.mdia.minf.stbl.stts;o.sample_counts=[],o.sample_deltas=[];let a=e.mdia.minf.stbl.ctts;a&&(a.sample_counts=[],a.sample_offsets=[]);let l=e.mdia.minf.stbl.stss,d=e.mdia.minf.stbl.boxes.indexOf(l);d!==-1&&(e.mdia.minf.stbl.boxes[d]=null)}}static initSampleGroups(t,e,i,r,n){e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]);for(let o=0;o<i.length;o++){let a=i[o].grouping_type+"/"+i[o].grouping_type_parameter,l=new Qe(i[o].grouping_type,i[o].grouping_type_parameter,i[o]);e&&(e.sample_groups_info[a]=l),t.sample_groups_info[a]||(t.sample_groups_info[a]=l);for(let d=0;d<r.length;d++)r[d].grouping_type===i[o].grouping_type&&(l.description=r[d],l.description.used=!0);if(n)for(let d=0;d<n.length;d++)n[d].grouping_type===i[o].grouping_type&&(l.fragment_description=n[d],l.fragment_description.used=!0,l.is_fragment=!0)}if(e){if(n){for(let o=0;o<n.length;o++)if(!n[o].used&&n[o].version>=2){let a=n[o].grouping_type+"/0",l=new Qe(n[o].grouping_type,0);l.is_fragment=!0,e.sample_groups_info[a]||(e.sample_groups_info[a]=l)}}}else for(let o=0;o<r.length;o++)if(!r[o].used&&r[o].version>=2){let a=r[o].grouping_type+"/0",l=new Qe(r[o].grouping_type,0);t.sample_groups_info[a]||(t.sample_groups_info[a]=l)}}static setSampleGroupProperties(t,e,i,r){e.sample_groups=[];for(let n in r)if(e.sample_groups[n]={grouping_type:r[n].grouping_type,grouping_type_parameter:r[n].grouping_type_parameter},i>=r[n].last_sample_in_run&&(r[n].last_sample_in_run<0&&(r[n].last_sample_in_run=0),r[n].entry_index++,r[n].entry_index<=r[n].sbgp.entries.length-1&&(r[n].last_sample_in_run+=r[n].sbgp.entries[r[n].entry_index].sample_count)),r[n].entry_index<=r[n].sbgp.entries.length-1?e.sample_groups[n].group_description_index=r[n].sbgp.entries[r[n].entry_index].group_description_index:e.sample_groups[n].group_description_index=-1,e.sample_groups[n].group_description_index!==0){let o;if(r[n].fragment_description?o=r[n].fragment_description:o=r[n].description,e.sample_groups[n].group_description_index>0){let a;e.sample_groups[n].group_description_index>65535?a=(e.sample_groups[n].group_description_index>>16)-1:a=e.sample_groups[n].group_description_index-1,o&&a>=0&&(e.sample_groups[n].description=o.entries[a])}else o&&o.version>=2&&o.default_group_description_index>0&&(e.sample_groups[n].description=o.entries[o.default_group_description_index-1])}}static process_sdtp(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))}buildSampleLists(){for(let t=0;t<this.moov.traks.length;t++)this.buildTrakSampleLists(this.moov.traks[t])}buildTrakSampleLists(t){let e,i,r,n,o,a;t.samples=[],t.samples_duration=0,t.samples_size=0;let l=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,d=t.mdia.minf.stbl.stsc,p=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,h=t.mdia.minf.stbl.stts,m=t.mdia.minf.stbl.ctts,_=t.mdia.minf.stbl.stss,U=t.mdia.minf.stbl.stsd,S=t.mdia.minf.stbl.subs,T=t.mdia.minf.stbl.stdp,F=t.mdia.minf.stbl.sbgps,R=t.mdia.minf.stbl.sgpds,P=-1,O=-1,A=-1,j=-1,le=0,L=0,K=0;if(s.initSampleGroups(t,null,F,R),typeof p!="undefined"){for(e=0;e<p.sample_sizes.length;e++){let y={number:e,track_id:t.tkhd.track_id,timescale:t.mdia.mdhd.timescale,alreadyRead:0,size:p.sample_sizes[e]};t.samples[e]=y,t.samples_size+=y.size,e===0?(r=1,i=0,y.chunk_index=r,y.chunk_run_index=i,a=d.samples_per_chunk[i],o=0,i+1<d.first_chunk.length?n=d.first_chunk[i+1]-1:n=1/0):e<a?(y.chunk_index=r,y.chunk_run_index=i):(r++,y.chunk_index=r,o=0,r<=n||(i++,i+1<d.first_chunk.length?n=d.first_chunk[i+1]-1:n=1/0),y.chunk_run_index=i,a+=d.samples_per_chunk[i]),y.description_index=d.sample_description_index[y.chunk_run_index]-1,y.description=U.entries[y.description_index],y.offset=l.chunk_offsets[y.chunk_index-1]+o,o+=y.size,e>P&&(O++,P<0&&(P=0),P+=h.sample_counts[O]),e>0?(t.samples[e-1].duration=h.sample_deltas[O],t.samples_duration+=t.samples[e-1].duration,y.dts=t.samples[e-1].dts+t.samples[e-1].duration):y.dts=0,m?(e>=A&&(j++,A<0&&(A=0),A+=m.sample_counts[j]),y.cts=t.samples[e].dts+m.sample_offsets[j]):y.cts=y.dts,_?(e===_.sample_numbers[le]-1?(y.is_sync=!0,le++):(y.is_sync=!1,y.degradation_priority=0),S&&S.entries[L].sample_delta+K===e+1&&(y.subsamples=S.entries[L].subsamples,K+=S.entries[L].sample_delta,L++)):y.is_sync=!0,s.process_sdtp(t.mdia.minf.stbl.sdtp,y,y.number),T?y.degradation_priority=T.priority[e]:y.degradation_priority=0,S&&S.entries[L].sample_delta+K===e&&(y.subsamples=S.entries[L].subsamples,K+=S.entries[L].sample_delta),(F.length>0||R.length>0)&&s.setSampleGroupProperties(t,y,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}}updateSampleLists(){let t,e,i,r,n;if(this.moov!==void 0)for(;this.lastMoofIndex<this.moofs.length;){let o=this.moofs[this.lastMoofIndex];if(this.lastMoofIndex++,o.type==="moof"){let a=o;for(let l=0;l<a.trafs.length;l++){let d=a.trafs[l],p=this.getTrackById(d.tfhd.track_id),h=this.getTrexById(d.tfhd.track_id);d.tfhd.flags&ue?t=d.tfhd.default_sample_description_index:t=h?h.default_sample_description_index:1,d.tfhd.flags&ce?e=d.tfhd.default_sample_duration:e=h?h.default_sample_duration:0,d.tfhd.flags&pe?i=d.tfhd.default_sample_size:i=h?h.default_sample_size:0,d.tfhd.flags&me?r=d.tfhd.default_sample_flags:r=h?h.default_sample_flags:0,d.sample_number=0,d.sbgps.length>0&&s.initSampleGroups(p,d,d.sbgps,p.mdia.minf.stbl.sgpds,d.sgpds);for(let m=0;m<d.truns.length;m++){let _=d.truns[m];for(let U=0;U<_.sample_count;U++){let S=t-1,T=r;_.flags&re?T=_.sample_flags[U]:U===0&&_.flags&he&&(T=_.first_sample_flags);let F=i;_.flags&ie&&(F=_.sample_size[U]),p.samples_size+=F;let R=e;_.flags&te&&(R=_.sample_duration[U]),p.samples_duration+=R;let P;p.first_traf_merged||U>0?P=p.samples[p.samples.length-1].dts+p.samples[p.samples.length-1].duration:(d.tfdt?P=d.tfdt.baseMediaDecodeTime:P=0,p.first_traf_merged=!0);let O=P;_.flags&se&&(O=P+_.sample_composition_time_offset[U]);let A=!!(d.tfhd.flags&de),j=!!(d.tfhd.flags&Vn),le=!!(_.flags&ee),L=0;A?L=d.tfhd.base_data_offset:j||m===0?L=a.start:L=n;let K;m===0&&U===0?le?K=L+_.data_offset:K=L:K=n,n=K+F;let y=d.sample_number;d.sample_number++;let Cn={cts:O,description_index:S,description:p.mdia.minf.stbl.stsd.entries[S],dts:P,duration:R,moof_number:this.lastMoofIndex,number_in_traf:y,number:p.samples.length,offset:K,size:F,timescale:p.mdia.mdhd.timescale,track_id:p.tkhd.track_id,is_sync:!(T>>16&1),is_leading:T>>26&3,depends_on:T>>24&3,is_depended_on:T>>22&3,has_redundancy:T>>20&3,degradation_priority:T&65535};d.first_sample_index=p.samples.length,p.samples.push(Cn),(d.sbgps.length>0||d.sgpds.length>0||p.mdia.minf.stbl.sbgps.length>0||p.mdia.minf.stbl.sgpds.length>0)&&s.setSampleGroupProperties(p,Cn,Cn.number_in_traf,d.sample_groups_info)}}if(d.subs){p.has_fragment_subsamples=!0;let m=d.first_sample_index;for(let _=0;_<d.subs.entries.length;_++){m+=d.subs.entries[_].sample_delta;let U=p.samples[m-1];U.subsamples=d.subs.entries[_].subsamples}}}}}}getSample(t,e){let i=t.samples[e];if(!this.moov)return null;if(!i.data)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.samplesDataSize+=i.size,u.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+i.size+" (total: "+this.samplesDataSize+")");else if(i.alreadyRead===i.size)return i;for(;;){let r=this.stream.findPosition(!0,i.offset+i.alreadyRead,!1);if(r>-1){let n=this.stream.buffers[r],o=n.byteLength-(i.offset+i.alreadyRead-n.fileStart);if(i.size-i.alreadyRead<=o)return u.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+i.alreadyRead+" offset: "+(i.offset+i.alreadyRead-n.fileStart)+" read size: "+(i.size-i.alreadyRead)+" full size: "+i.size+")"),E.memcpy(i.data.buffer,i.alreadyRead,n,i.offset+i.alreadyRead-n.fileStart,i.size-i.alreadyRead),n.usedBytes+=i.size-i.alreadyRead,this.stream.logBufferLevel(),i.alreadyRead=i.size,i;if(o===0)return null;u.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+i.alreadyRead+" offset: "+(i.offset+i.alreadyRead-n.fileStart)+" read size: "+o+" full size: "+i.size+")"),E.memcpy(i.data.buffer,i.alreadyRead,n,i.offset+i.alreadyRead-n.fileStart,o),i.alreadyRead+=o,n.usedBytes+=o,this.stream.logBufferLevel()}else return null}}releaseSample(t,e){let i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=null,i.alreadyRead=0,i.size):0}getAllocatedSampleDataSize(){return this.samplesDataSize}getCodecs(){let t="";for(let e=0;e<this.moov.traks.length;e++){let i=this.moov.traks[e];e>0&&(t+=","),t+=i.mdia.minf.stbl.stsd.entries[0].getCodec()}return t}getTrexById(t){if(!this.moov||!this.moov.mvex)return null;for(let e=0;e<this.moov.mvex.trexs.length;e++){let i=this.moov.mvex.trexs[e];if(i.track_id===t)return i}return null}getTrackById(t){if(this.moov===void 0)return null;for(let e=0;e<this.moov.traks.length;e++){let i=this.moov.traks[e];if(i.tkhd.track_id===t)return i}return null}flattenItemInfo(){var r;let t=this.items,e=this.entity_groups,i=this.meta;if(i!=null&&i.hdlr!==void 0&&i.iinf!==void 0){for(let n=0;n<i.iinf.item_infos.length;n++){let o=i.iinf.item_infos[n].item_ID;t[o]={id:o,name:i.iinf.item_infos[n].item_name,ref_to:[],content_type:i.iinf.item_infos[n].content_type,content_encoding:i.iinf.item_infos[n].content_encoding,item_uri_type:i.iinf.item_infos[n].item_uri_type,type:i.iinf.item_infos[n].item_type?i.iinf.item_infos[n].item_type:"mime",protection:i.iinf.item_infos[n].item_protection_index>0?i.ipro.protections[i.iinf.item_infos[n].item_protection_index-1]:void 0}}if(i.grpl)for(let n=0;n<i.grpl.boxes.length;n++){let o=i.grpl.boxes[n];e[o.group_id]={id:o.group_id,entity_ids:o.entity_ids,type:o.type}}if(i.iloc)for(let n=0;n<i.iloc.items.length;n++){let o=i.iloc.items[n],a=t[o.item_ID];o.data_reference_index!==0&&(u.warn("Item storage with reference to other files: not supported"),a.source=i.dinf.boxes[o.data_reference_index-1]),a.extents=[],a.size=0;for(let l=0;l<o.extents.length;l++)a.extents[l]={offset:o.extents[l].extent_offset+o.base_offset,length:o.extents[l].extent_length,alreadyRead:0},o.construction_method===1&&(a.extents[l].offset+=i.idat.start+i.idat.hdr_size),a.size+=a.extents[l].length}if(i.pitm&&(t[i.pitm.item_id].primary=!0),i.iref)for(let n=0;n<i.iref.references.length;n++){let o=i.iref.references[n];for(let a=0;a<o.references.length;a++)t[o.from_item_ID].ref_to.push({type:o.type,id:o.references[a]})}if(i.iprp)for(let n=0;n<i.iprp.ipmas.length;n++){let o=i.iprp.ipmas[n];for(let a=0;a<o.associations.length;a++){let l=o.associations[a],d=(r=t[l.id])!=null?r:e[l.id];if(d){d.properties===void 0&&(d.properties={boxes:[]});for(let p=0;p<l.props.length;p++){let h=l.props[p];if(h.property_index>0&&h.property_index-1<i.iprp.ipco.boxes.length){let m=i.iprp.ipco.boxes[h.property_index-1];d.properties[m.type]=m,d.properties.boxes.push(m)}}}}}}}getItem(t){if(!this.meta)return null;let e=this.items[t];if(!e.data&&e.size)e.data=new Uint8Array(e.size),e.alreadyRead=0,this.itemsDataSize+=e.size,u.debug("ISOFile","Allocating item #"+t+" of size "+e.size+" (total: "+this.itemsDataSize+")");else if(e.alreadyRead===e.size)return e;for(let i=0;i<e.extents.length;i++){let r=e.extents[i];if(r.alreadyRead!==r.length){let n=this.stream.findPosition(!0,r.offset+r.alreadyRead,!1);if(n>-1){let o=this.stream.buffers[n],a=o.byteLength-(r.offset+r.alreadyRead-o.fileStart);if(r.length-r.alreadyRead<=a)u.debug("ISOFile","Getting item #"+t+" extent #"+i+" data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-o.fileStart)+" read size: "+(r.length-r.alreadyRead)+" full extent size: "+r.length+" full item size: "+e.size+")"),E.memcpy(e.data.buffer,e.alreadyRead,o,r.offset+r.alreadyRead-o.fileStart,r.length-r.alreadyRead),(!this.parsingMdat||this.discardMdatData)&&(o.usedBytes+=r.length-r.alreadyRead),this.stream.logBufferLevel(),e.alreadyRead+=r.length-r.alreadyRead,r.alreadyRead=r.length;else return u.debug("ISOFile","Getting item #"+t+" extent #"+i+" partial data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-o.fileStart)+" read size: "+a+" full extent size: "+r.length+" full item size: "+e.size+")"),E.memcpy(e.data.buffer,e.alreadyRead,o,r.offset+r.alreadyRead-o.fileStart,a),r.alreadyRead+=a,e.alreadyRead+=a,(!this.parsingMdat||this.discardMdatData)&&(o.usedBytes+=a),this.stream.logBufferLevel(),null}else return null}}return e.alreadyRead===e.size?e:null}releaseItem(t){let e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(let i=0;i<e.extents.length;i++){let r=e.extents[i];r.alreadyRead=0}return e.size}else return 0}processItems(t){for(let e in this.items){let i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}}hasItem(t){for(let e in this.items){let i=this.items[e];if(i.name===t)return i.id}return-1}getMetaHandler(){return this.meta?this.meta.hdlr.handler:null}getPrimaryItem(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)}itemToFragmentedTrackFile({itemId:t}={}){let e=null;if(t?e=this.getItem(t):e=this.getPrimaryItem(),e===null)return null;let i=new s;i.discardMdatData=!1;let r={type:e.type,description_boxes:e.properties.boxes};e.properties.ispe&&(r.width=e.properties.ispe.image_width,r.height=e.properties.ispe.image_height);let n=i.addTrack(r);return n?(i.addSample(n,e.data),i):null}processIncompleteBox(t){if(t.type==="mdat"){let e=new J(t.size);return this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,e.original_size=t.original_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.transferMdatData(),this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)}else return t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),(this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1)?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1)}hasIncompleteMdat(){return this.parsingMdat!==null}transferMdatData(t){let e=t!=null?t:this.parsingMdat;if(this.discardMdatData){u.debug("ISOFile","Discarding 'mdat' data, not transferring it to the mdat box stream");return}if(!e){u.warn("ISOFile","Cannot transfer 'mdat' data, no mdat box is being parsed");return}let i=this.stream.findPosition(!0,e.start+e.hdr_size,!1),r=this.stream.findPosition(!0,e.start+e.size,!1);if(i===-1||r===-1){console.trace(e,i,r),u.warn("ISOFile","Cannot transfer 'mdat' data, start or end buffer not found");return}e.stream=new Z;for(let n=i;n<=r;n++){let o=this.stream.buffers[n],a=n===i?e.start+e.hdr_size-o.fileStart:0,l=n===r?e.start+e.size-o.fileStart:o.byteLength;if(l>a){u.debug("ISOFile","Transferring 'mdat' data from buffer #"+n+" ("+a+" to "+l+")");let d=l-a,p=new H(d),h=e.stream.getAbsoluteEndPosition();E.memcpy(p,0,o,a,d),p.fileStart=h,e.stream.insertBuffer(p),o.usedBytes+=d}}}processIncompleteMdat(){let t=this.parsingMdat;return this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(u.debug("ISOFile","Found 'mdat' end in buffered data"),this.transferMdatData(),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)}restoreParsePosition(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)}saveParsePosition(){this.lastBoxStartPosition=this.stream.getPosition()}updateUsedBytes(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))}addBox(t){return c.prototype.addBox.call(this,t)}init(t={}){let e=this.addBox(new ze);e.major_brand=t.brands&&t.brands[0]||"iso4",e.minor_version=0,e.compatible_brands=t.brands||["iso4"];let i=this.addBox(new ne);i.addBox(new oe);let r=i.addBox(new Pe);return r.timescale=t.timescale||600,r.rate=t.rate||65536,r.creation_time=0,r.modification_time=0,r.duration=t.duration||0,r.volume=t.width?0:256,r.matrix=[65536,0,0,0,65536,0,0,0,1073741824],r.next_track_id=1,this}addTrack(t={}){this.moov||this.init(t);let e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";let i=this.moov.addBox(new ge);this.moov.mvhd.next_track_id=e.id+1;let r=i.addBox(new We);r.flags=oo|ao|fo,r.creation_time=0,r.modification_time=0,r.track_id=e.id,r.duration=e.duration||0,r.layer=e.layer||0,r.alternate_group=0,r.volume=1,r.matrix=[65536,0,0,0,65536,0,0,0,1073741824],r.width=e.width<<16,r.height=e.height<<16;let n=i.addBox(new Se),o=n.addBox(new Fe);o.creation_time=0,o.modification_time=0,o.timescale=e.timescale||1,o.duration=e.media_duration||0,o.language=e.language||"und";let a=n.addBox(new ke);a.handler=e.hdlr||"vide",a.name=e.name||"Track created with MP4Box.js";let l=n.addBox(new Ie);l.extended_language=e.language||"fr-FR";let d=n.addBox(new Be),p=M.sampleEntry[e.type];if(!p)return;let h=new p;if(h.data_reference_index=1,h instanceof B){let A=h,j=d.addBox(new Je);j.graphicsmode=0,j.opcolor=[0,0,0],A.width=e.width,A.height=e.height,A.horizresolution=72<<16,A.vertresolution=72<<16,A.frame_count=1,A.compressorname=e.type+" Compressor",A.depth=24,e.avcDecoderConfigRecord?A.addBox(new xe).parse(new V(e.avcDecoderConfigRecord)):e.hevcDecoderConfigRecord&&A.addBox(new Te).parse(new V(e.hevcDecoderConfigRecord))}else if(h instanceof k){let A=h,j=d.addBox(new Oe);j.balance=e.balance||0,A.channel_count=e.channel_count||2,A.samplesize=e.samplesize||16,A.samplerate=e.samplerate||65536}else h instanceof be?d.addBox(new ye):h instanceof D?(d.addBox(new Ve),h instanceof Re&&(h.namespace=e.namespace||"nonamespace",h.schema_location=e.schema_location||"",h.auxiliary_mime_types=e.auxiliary_mime_types||"")):h instanceof N?d.addBox(new Q):h instanceof X?d.addBox(new Q):d.addBox(new Q);e.description&&h.addBox.call(h,e.description),e.description_boxes&&e.description_boxes.forEach(function(A){h.addBox.call(h,A)}),d.addBox(new Ue);let m=d.addBox(new Me),_=new Xe;_.flags=1,m.addEntry(_);let U=d.addBox(new we);U.addBox(new je).addEntry(h);let T=U.addBox(new qe);T.sample_counts=[],T.sample_deltas=[];let F=U.addBox(new Ge);F.first_chunk=[],F.samples_per_chunk=[],F.sample_description_index=[];let R=U.addBox(new He);R.chunk_offsets=[];let P=U.addBox(new Ke);P.sample_sizes=[];let O=this.moov.mvex.addBox(new ae);return O.track_id=e.id,O.default_sample_description_index=e.default_sample_description_index||1,O.default_sample_duration=e.default_sample_duration||0,O.default_sample_size=e.default_sample_size||0,O.default_sample_flags=e.default_sample_flags||0,this.buildTrakSampleLists(i),e.id}addSample(t,e,{sample_description_index:i,duration:r=1,cts:n=0,dts:o=0,is_sync:a=!1,is_leading:l=0,depends_on:d=0,is_depended_on:p=0,has_redundancy:h=0,degradation_priority:m=0,offset:_=0,subsamples:U}={}){let S=this.getTrackById(t);if(S===null)return;let T=i?i-1:0,F={number:S.samples.length,track_id:S.tkhd.track_id,timescale:S.mdia.mdhd.timescale,description_index:T,description:S.mdia.minf.stbl.stsd.entries[T],data:e,size:e.byteLength,alreadyRead:e.byteLength,duration:r,cts:n,dts:o,is_sync:a,is_leading:l,depends_on:d,is_depended_on:p,has_redundancy:h,degradation_priority:m,offset:_,subsamples:U};S.samples.push(F),S.samples_size+=F.size,S.samples_duration+=F.duration,S.first_dts===void 0&&(S.first_dts=o),this.processSamples();let R=this.addBox(this.createSingleSampleMoof(F));R.computeSize(),R.trafs[0].truns[0].data_offset=R.size+8;let P=this.addBox(new J);return P.data=new Uint8Array(e),F}createSingleSampleMoof(t){let e=0;t.is_sync?e=1<<25:e=65536;let i=new Ae,r=i.addBox(new De);r.sequence_number=this.nextMoofNumber,this.nextMoofNumber++;let n=i.addBox(new ve),o=this.getTrackById(t.track_id),a=n.addBox(new $e);a.track_id=t.track_id,a.flags=Vn;let l=n.addBox(new Ye);l.baseMediaDecodeTime=t.dts-(o.first_dts||0);let d=n.addBox(new Ze);return d.flags=ee|te|ie|re|se,d.data_offset=0,d.first_sample_flags=0,d.sample_count=1,d.sample_duration=[t.duration],d.sample_size=[t.size],d.sample_flags=[e],d.sample_composition_time_offset=[t.cts-t.dts],i}print(t){t.indent="";for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)}};function To(s=!1,t){return new ft(t,!s)}var Zn={};Rn(Zn,{Descriptor:()=>Y,ES_Descriptor:()=>lt,MPEG4DescriptorParser:()=>nr});var xo=3,sr=4,Wn=5,yo=6,Y=class s{constructor(t,e){this.tag=t;this.size=e;this.descs=[]}parse(t){this.data=t.readUint8Array(this.size)}findDescriptor(t){for(let e=0;e<this.descs.length;e++)if(this.descs[e].tag===t)return this.descs[e];return null}parseOneDescriptor(t){let e=0,i=t.readUint8(),r=t.readUint8();for(;r&128;)e=(e<<7)+(r&127),r=t.readUint8();e=(e<<7)+(r&127),u.debug("Descriptor","Found "+(rr[i]||"Descriptor "+i)+", size "+e+" at position "+t.getPosition());let n=rr[i]?new Fo[rr[i]](e):new s(e);return n.parse(t),n}parseRemainingDescriptors(t){var i;let e=t.getPosition();for(;t.getPosition()<e+this.size;){let r=(i=this.parseOneDescriptor)==null?void 0:i.call(this,t);this.descs.push(r)}}},lt=class extends Y{constructor(t){super(xo,t)}parse(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){let e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)}getOTI(){let t=this.findDescriptor(sr);return t?t.oti:0}getAudioConfig(){let t=this.findDescriptor(sr);if(!t)return null;let e=t.findDescriptor(Wn);if(e&&e.data){let i=(e.data[0]&248)>>3;return i===31&&e.data.length>=2&&(i=32+((e.data[0]&7)<<3)+((e.data[1]&224)>>5)),i}else return null}},qn=class extends Y{constructor(t){super(sr,t)}parse(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)}},Yn=class extends Y{constructor(t){super(Wn,t)}},$n=class extends Y{constructor(t){super(yo,t)}},Fo={Descriptor:Y,ES_Descriptor:lt,DecoderConfigDescriptor:qn,DecoderSpecificInfo:Yn,SLConfigDescriptor:$n},rr={[xo]:"ES_Descriptor",[sr]:"DecoderConfigDescriptor",[Wn]:"DecoderSpecificInfo",[yo]:"SLConfigDescriptor"},nr=class{constructor(){this.parseOneDescriptor=Y.prototype.parseOneDescriptor}getDescriptorName(t){return rr[t]}};var Xn=class{parseSample(t){var r;let e=[],i=new V(t.buffer);for(;!i.isEos();){let n=I(i,!1);n.code===v&&((r=n.box)==null?void 0:r.type)==="vttc"&&e.push(n.box)}return e}getText(t,e,i){function r(l,d){let p=l.toString();return p.length>=d?p:new Array(d-p.length+1).join("0")+p}function n(l){let d=Math.floor(l/3600),p=Math.floor((l-d*3600)/60),h=Math.floor(l-d*3600-p*60),m=Math.floor((l-d*3600-p*60-h)*1e3);return""+r(d,2)+":"+r(p,2)+":"+r(h,2)+"."+r(m,3)}let o=this.parseSample(i),a="";for(let l=0;l<o.length;l++){let d=o[l];a+=n(t)+" --> "+n(e)+`\r
`,a+=d.payl.text}return a}},Jn=class{parseSample(t){let e={resources:[],documentString:"",document:void 0},i=new V(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=i.readString(t.data.length);else if(e.documentString=i.readString(t.subsamples[0].size),t.subsamples.length>1)for(let r=1;r<t.subsamples.length;r++)e.resources[r]=i.readUint8Array(t.subsamples[r].size);return typeof DOMParser!="undefined"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e}},Qn=class{parseSample(t){return new V(t.data.buffer).readString(t.data.length)}parseConfig(t){let e=new V(t.buffer);return e.readUint32(),e.readCString()}};var io={};Rn(io,{CoLLBox:()=>xr,ItemContentIDPropertyBox:()=>Ln,OpusSampleEntry:()=>Ei,SmDmBox:()=>Ds,a1lxBox:()=>or,a1opBox:()=>ar,ac_3SampleEntry:()=>ki,ac_4SampleEntry:()=>Ti,aebrBox:()=>Fr,afbrBox:()=>Er,albcBox:()=>Dr,alstSampleGroupEntry:()=>un,altrBox:()=>Pr,auxCBox:()=>fr,av01SampleEntry:()=>ni,av1CBox:()=>Zt,avc1SampleEntry:()=>ti,avc2SampleEntry:()=>ii,avc3SampleEntry:()=>ri,avc4SampleEntry:()=>si,avcCBox:()=>xe,avllSampleGroupEntry:()=>cn,avs3SampleEntry:()=>Bi,avssSampleGroupEntry:()=>pn,brstBox:()=>Lr,btrtBox:()=>lr,bxmlBox:()=>Ut,ccstBox:()=>dr,cdefBox:()=>ur,clapBox:()=>cr,clefBox:()=>Bs,clliBox:()=>pr,cmexBox:()=>mr,cminBox:()=>hr,cmpdBox:()=>_r,co64Box:()=>br,colrBox:()=>ei,cprtBox:()=>yr,cslgBox:()=>gr,cttsBox:()=>Sr,dOpsBox:()=>Ir,dac3Box:()=>Br,dav1SampleEntry:()=>oi,dec3Box:()=>Ur,dfLaBox:()=>wr,dimmBox:()=>Ar,dinfBox:()=>Ue,dmax:()=>vr,dmedBox:()=>Mr,dobrBox:()=>Cr,drefBox:()=>Me,drepBox:()=>zr,dtrtSampleGroupEntry:()=>mn,dvh1SampleEntry:()=>mi,dvheSampleEntry:()=>hi,ec_3SampleEntry:()=>Fi,edtsBox:()=>At,elngBox:()=>Ie,elstBox:()=>kr,emsgBox:()=>Tr,encaSampleEntry:()=>Oi,encmSampleEntry:()=>Ki,encsSampleEntry:()=>Vi,enctSampleEntry:()=>ji,encuSampleEntry:()=>Hi,encvSampleEntry:()=>Ri,enofBox:()=>Us,eqivBox:()=>Nr,esdsBox:()=>Xt,etypBox:()=>Vt,fLaCSampleEntry:()=>Ni,favcBox:()=>Rr,fielBox:()=>Wr,fobrBox:()=>Or,freeBox:()=>yt,frmaBox:()=>Zr,ftypBox:()=>ze,grplBox:()=>Ot,hdlrBox:()=>ke,hev1SampleEntry:()=>li,hev2SampleEntry:()=>di,hinfBox:()=>kt,hmhdBox:()=>ye,hntiBox:()=>zt,hvc1SampleEntry:()=>ai,hvc2SampleEntry:()=>fi,hvcCBox:()=>Te,hvt1SampleEntry:()=>ui,iaugBox:()=>Hr,idatBox:()=>xt,iinfBox:()=>jt,ilocBox:()=>Kt,imirBox:()=>Xr,infeBox:()=>Gt,iodsBox:()=>St,ipcoBox:()=>Rt,ipmaBox:()=>Jr,iproBox:()=>wt,iprpBox:()=>Nt,irefBox:()=>Kn,irotBox:()=>Qr,ispeBox:()=>es,itaiBox:()=>ts,j2kHBox:()=>Ht,j2kiSampleEntry:()=>Ui,kindBox:()=>is,levaBox:()=>rs,lhe1SampleEntry:()=>ci,lhv1SampleEntry:()=>pi,lhvCBox:()=>ss,lselBox:()=>ns,m4aeSampleEntry:()=>zi,maxrBox:()=>os,mdatBox:()=>J,mdcvBox:()=>as,mdhdBox:()=>Fe,mdiaBox:()=>Se,mecoBox:()=>It,mehdBox:()=>Ee,metaBox:()=>Yt,mettSampleEntry:()=>$t,metxSampleEntry:()=>Wt,mfhdBox:()=>De,mfraBox:()=>Mt,mfroBox:()=>fs,mha1SampleEntry:()=>Di,mha2SampleEntry:()=>Pi,mhm1SampleEntry:()=>Li,mhm2SampleEntry:()=>Ci,minfBox:()=>Be,mjp2SampleEntry:()=>wi,mjpgSampleEntry:()=>Ai,moofBox:()=>Ae,moovBox:()=>ne,mp4aSampleEntry:()=>Ii,mp4sSampleEntry:()=>Gi,mp4vSampleEntry:()=>Mi,mskCBox:()=>ls,msrcTrackGroupTypeBox:()=>Qs,mvexBox:()=>oe,mvhdBox:()=>Pe,mvifSampleGroupEntry:()=>hn,nmhdBox:()=>Q,npckBox:()=>ds,numpBox:()=>us,padbBox:()=>cs,panoBox:()=>Vr,paspBox:()=>ps,paylBox:()=>ms,paytBox:()=>hs,pdinBox:()=>_s,piffLsmBox:()=>kn,piffPsshBox:()=>Tn,piffSencBox:()=>Fn,piffTencBox:()=>En,piffTfrfBox:()=>Dn,piffTfxdBox:()=>Pn,pitmBox:()=>qt,pixiBox:()=>bs,pmaxBox:()=>xs,prdiBox:()=>ys,prftBox:()=>gs,prgrBox:()=>Yr,profBox:()=>ws,prolSampleGroupEntry:()=>_n,psshBox:()=>Ss,pymdBox:()=>$r,rapSampleGroupEntry:()=>bn,rashSampleGroupEntry:()=>xn,resvSampleEntry:()=>qi,rinfBox:()=>Dt,rollSampleGroupEntry:()=>yn,rtp_Box:()=>vs,saioBox:()=>Ms,saizBox:()=>Is,sbgpBox:()=>Qi,sbpmBox:()=>ks,sbttSampleEntry:()=>Wi,schiBox:()=>Pt,schmBox:()=>Ts,scifSampleGroupEntry:()=>gn,scnmSampleGroupEntry:()=>Sn,sdp_Box:()=>Fs,sdtpBox:()=>er,seigSampleGroupEntry:()=>Bn,sencBox:()=>Es,sgpdBox:()=>tr,sidxBox:()=>ir,sinfBox:()=>Et,skipBox:()=>gt,slidBox:()=>Gr,smhdBox:()=>Oe,ssixBox:()=>Ps,stblBox:()=>we,stcoBox:()=>He,stdpBox:()=>Ls,sterBox:()=>jr,sthdBox:()=>Ve,stppSampleEntry:()=>Re,strdBox:()=>Ft,striBox:()=>Cs,strkBox:()=>Tt,stsaSampleGroupEntry:()=>Un,stscBox:()=>Ge,stsdBox:()=>je,stsgBox:()=>Ns,stshBox:()=>Rs,stssBox:()=>Os,stszBox:()=>Ke,sttsBox:()=>qe,stviBox:()=>Hs,stxtSampleEntry:()=>Zi,stypBox:()=>Vs,stz2Box:()=>Gs,subsBox:()=>js,syncSampleGroupEntry:()=>wn,taicBox:()=>Ks,taptBox:()=>As,teleSampleGroupEntry:()=>An,tencBox:()=>qs,tfdtBox:()=>Ye,tfhdBox:()=>$e,tfraBox:()=>Ys,tkhdBox:()=>We,tmaxBox:()=>$s,tminBox:()=>Ws,totlBox:()=>Zs,tpayBox:()=>Xs,tpylBox:()=>Js,trafBox:()=>ve,trakBox:()=>ge,trefBox:()=>to,trepBox:()=>en,trexBox:()=>ae,trgrBox:()=>Lt,trpyBox:()=>tn,trunBox:()=>Ze,tsasSampleGroupEntry:()=>vn,tsclSampleGroupEntry:()=>Mn,tselBox:()=>rn,tsynBox:()=>Kr,tx3gSampleEntry:()=>Xi,txtcBox:()=>sn,tycoBox:()=>nn,udesBox:()=>on,udtaBox:()=>Ct,uncCBox:()=>an,uncvSampleEntry:()=>vi,urlBox:()=>Xe,urnBox:()=>fn,viprSampleGroupEntry:()=>In,vmhdBox:()=>Je,vp08SampleEntry:()=>gi,vp09SampleEntry:()=>Si,vpcCBox:()=>Jt,vttCBox:()=>ln,vttcBox:()=>vt,vvc1SampleEntry:()=>_i,vvcCBox:()=>Qt,vvcNSampleEntry:()=>yi,vvi1SampleEntry:()=>bi,vvnCBox:()=>dn,vvs1SampleEntry:()=>xi,wbbrBox:()=>qr,wvttSampleEntry:()=>Ji,xmlBox:()=>Bt});var or=class extends c{constructor(){super(...arguments);this.box_name="AV1LayeredImageIndexingProperty"}parse(e){let r=((e.readUint8()&1&1)+1)*16;this.layer_size=[];for(let n=0;n<3;n++)r===16?this.layer_size[n]=e.readUint16():this.layer_size[n]=e.readUint32()}};or.fourcc="a1lx";var ar=class extends c{constructor(){super(...arguments);this.box_name="OperatingPointSelectorProperty"}parse(e){this.op_index=e.readUint8()}};ar.fourcc="a1op";var fr=class extends f{constructor(){super(...arguments);this.box_name="AuxiliaryTypeProperty"}parse(e){this.parseFullHeader(e),this.aux_type=e.readCString();let i=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=e.readUint8Array(i)}};fr.fourcc="auxC";var lr=class extends c{constructor(){super(...arguments);this.box_name="BitRateBox"}parse(e){this.bufferSizeDB=e.readUint32(),this.maxBitrate=e.readUint32(),this.avgBitrate=e.readUint32()}};lr.fourcc="btrt";var dr=class extends f{constructor(){super(...arguments);this.box_name="CodingConstraintsBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8();this.all_ref_pics_intra=(i&128)===128,this.intra_pred_used=(i&64)===64,this.max_ref_per_pic=(i&63)>>2,e.readUint24()}};dr.fourcc="ccst";var ur=class extends c{constructor(){super(...arguments);this.box_name="ComponentDefinitionBox"}parse(e){this.channel_count=e.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[];for(let i=0;i<this.channel_count;i++)this.channel_indexes.push(e.readUint16()),this.channel_types.push(e.readUint16()),this.channel_associations.push(e.readUint16())}};ur.fourcc="cdef";var cr=class extends c{constructor(){super(...arguments);this.box_name="CleanApertureBox"}parse(e){this.cleanApertureWidthN=e.readUint32(),this.cleanApertureWidthD=e.readUint32(),this.cleanApertureHeightN=e.readUint32(),this.cleanApertureHeightD=e.readUint32(),this.horizOffN=e.readUint32(),this.horizOffD=e.readUint32(),this.vertOffN=e.readUint32(),this.vertOffD=e.readUint32()}};cr.fourcc="clap";var pr=class extends c{constructor(){super(...arguments);this.box_name="ContentLightLevelBox"}parse(e){this.max_content_light_level=e.readUint16(),this.max_pic_average_light_level=e.readUint16()}};pr.fourcc="clli";var mr=class extends c{constructor(){super(...arguments);this.box_name="CameraExtrinsicMatrixProperty"}parse(e){this.flags&1&&(this.pos_x=e.readInt32()),this.flags&2&&(this.pos_y=e.readInt32()),this.flags&4&&(this.pos_z=e.readInt32()),this.flags&8&&(this.version===0?this.flags&16?(this.quat_x=e.readInt32(),this.quat_y=e.readInt32(),this.quat_z=e.readInt32()):(this.quat_x=e.readInt16(),this.quat_y=e.readInt16(),this.quat_z=e.readInt16()):this.version),this.flags&32&&(this.id=e.readUint32())}};mr.fourcc="cmex";var hr=class extends c{constructor(){super(...arguments);this.box_name="CameraIntrinsicMatrixProperty"}parse(e){this.focal_length_x=e.readInt32(),this.principal_point_x=e.readInt32(),this.principal_point_y=e.readInt32(),this.flags&1&&(this.focal_length_y=e.readInt32(),this.skew_factor=e.readInt32())}};hr.fourcc="cmin";var _r=class extends c{constructor(){super(...arguments);this.box_name="ComponentDefinitionBox"}parse(e){this.component_count=e.readUint32(),this.component_types=[],this.component_type_urls=[];for(let i=0;i<this.component_count;i++){let r=e.readUint16();this.component_types.push(r),r>=32768&&this.component_type_urls.push(e.readCString())}}};_r.fourcc="cmpd";var br=class extends f{constructor(){super(...arguments);this.box_name="ChunkLargeOffsetBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.chunk_offsets=[],this.version===0)for(let r=0;r<i;r++)this.chunk_offsets.push(e.readUint64())}write(e){this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length);for(let i=0;i<this.chunk_offsets.length;i++)e.writeUint64(this.chunk_offsets[i])}};br.fourcc="co64";var xr=class extends f{constructor(){super(...arguments);this.box_name="ContentLightLevelBox"}parse(e){this.parseFullHeader(e),this.maxCLL=e.readUint16(),this.maxFALL=e.readUint16()}};xr.fourcc="CoLL";var yr=class extends f{constructor(){super(...arguments);this.box_name="CopyrightBox"}parse(e){this.parseFullHeader(e),this.parseLanguage(e),this.notice=e.readCString()}};yr.fourcc="cprt";var dt=2147483647,gr=class extends f{constructor(){super(...arguments);this.box_name="CompositionToDecodeBox"}parse(e){this.parseFullHeader(e),this.version===0?(this.compositionToDTSShift=e.readInt32(),this.leastDecodeToDisplayDelta=e.readInt32(),this.greatestDecodeToDisplayDelta=e.readInt32(),this.compositionStartTime=e.readInt32(),this.compositionEndTime=e.readInt32()):this.version===1&&(this.compositionToDTSShift=e.readInt64(),this.leastDecodeToDisplayDelta=e.readInt64(),this.greatestDecodeToDisplayDelta=e.readInt64(),this.compositionStartTime=e.readInt64(),this.compositionEndTime=e.readInt64())}write(e){this.version=0,(this.compositionToDTSShift>dt||this.leastDecodeToDisplayDelta>dt||this.greatestDecodeToDisplayDelta>dt||this.compositionStartTime>dt||this.compositionEndTime>dt)&&(this.version=1),this.flags=0,this.version===0?(this.size=4*5,this.writeHeader(e),e.writeInt32(this.compositionToDTSShift),e.writeInt32(this.leastDecodeToDisplayDelta),e.writeInt32(this.greatestDecodeToDisplayDelta),e.writeInt32(this.compositionStartTime),e.writeInt32(this.compositionEndTime)):this.version===1&&(this.size=8*5,this.writeHeader(e),e.writeInt64(this.compositionToDTSShift),e.writeInt64(this.leastDecodeToDisplayDelta),e.writeInt64(this.greatestDecodeToDisplayDelta),e.writeInt64(this.compositionStartTime),e.writeInt64(this.compositionEndTime))}};gr.fourcc="cslg";var Sr=class extends f{constructor(){super(...arguments);this.box_name="CompositionOffsetBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.sample_counts=[],this.sample_offsets=[],this.version===0)for(let r=0;r<i;r++){this.sample_counts.push(e.readUint32());let n=e.readInt32();n<0&&u.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(n)}else if(this.version===1)for(let r=0;r<i;r++)this.sample_counts.push(e.readUint32()),this.sample_offsets.push(e.readInt32())}write(e){this.version=this.sample_offsets.some(i=>i<0)?1:0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length);for(let i=0;i<this.sample_counts.length;i++)e.writeUint32(this.sample_counts[i]),this.version===1?e.writeInt32(this.sample_offsets[i]):e.writeUint32(this.sample_offsets[i])}unpack(e){let i=0;for(let r=0;r<this.sample_counts.length;r++)for(let n=0;n<this.sample_counts[r];n++)e[i].pts=e[i].dts+this.sample_offsets[r],i++}};Sr.fourcc="ctts";var Br=class extends c{constructor(){super(...arguments);this.box_name="AC3SpecificBox"}parse(e){let i=e.readUint8(),r=e.readUint8(),n=e.readUint8();this.fscod=i>>6,this.bsid=i>>1&31,this.bsmod=(i&1)<<2|r>>6&3,this.acmod=r>>3&7,this.lfeon=r>>2&1,this.bit_rate_code=r&3|n>>5&7}};Br.fourcc="dac3";var Ur=class extends c{constructor(){super(...arguments);this.box_name="EC3SpecificBox"}parse(e){let i=e.readUint16();this.data_rate=i>>3,this.num_ind_sub=i&7,this.ind_subs=[];for(let r=0;r<this.num_ind_sub+1;r++){let n=e.readUint8(),o=e.readUint8(),a=e.readUint8(),l={fscod:n>>6,bsid:n>>1&31,bsmod:(n&1)<<4|o>>4&15,acmod:o>>1&7,lfeon:o&1,num_dep_sub:a>>1&15};this.ind_subs.push(l),l.num_dep_sub>0&&(l.chan_loc=(a&1)<<8|e.readUint8())}}};Ur.fourcc="dec3";var wr=class extends f{constructor(){super(...arguments);this.box_name="FLACSpecificBox"}parse(e){this.parseFullHeader(e);let i=127,r=128,n=[],o=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"],a;do{a=e.readUint8();let l=Math.min(a&i,o.length-1);l?e.readUint8Array(e.readUint24()):(e.readUint8Array(13),this.samplerate=e.readUint32()>>12,e.readUint8Array(20)),n.push(o[l])}while(a&r);this.numMetadataBlocks=n.length+" ("+n.join(", ")+")"}};wr.fourcc="dfLa";var Ar=class extends c{constructor(){super(...arguments);this.box_name="hintimmediateBytesSent"}parse(e){this.bytessent=e.readUint64()}};Ar.fourcc="dimm";var vr=class extends c{constructor(){super(...arguments);this.box_name="hintlongestpacket"}parse(e){this.time=e.readUint32()}};vr.fourcc="dmax";var Mr=class extends c{constructor(){super(...arguments);this.box_name="hintmediaBytesSent"}parse(e){this.bytessent=e.readUint64()}};Mr.fourcc="dmed";var Ir=class extends c{constructor(){super(...arguments);this.box_name="OpusSpecificBox"}parse(e){if(this.Version=e.readUint8(),this.OutputChannelCount=e.readUint8(),this.PreSkip=e.readUint16(),this.InputSampleRate=e.readUint32(),this.OutputGain=e.readInt16(),this.ChannelMappingFamily=e.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=e.readUint8(),this.CoupledCount=e.readUint8(),this.ChannelMapping=[];for(let i=0;i<this.OutputChannelCount;i++)this.ChannelMapping[i]=e.readUint8()}}};Ir.fourcc="dOps";var zr=class extends c{constructor(){super(...arguments);this.box_name="hintrepeatedBytesSent"}parse(e){this.bytessent=e.readUint64()}};zr.fourcc="drep";var kr=class extends f{constructor(){super(...arguments);this.box_name="EditListBox"}parse(e){this.parseFullHeader(e),this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++){let n={segment_duration:this.version===1?e.readUint64():e.readUint32(),media_time:this.version===1?e.readInt64():e.readInt32(),media_rate_integer:e.readInt16(),media_rate_fraction:e.readInt16()};this.entries.push(n)}}write(e){this.size=4+12*this.entries.length,this.writeHeader(e),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++){let r=this.entries[i];this.version===1?(e.writeUint64(r.segment_duration),e.writeInt64(r.media_time)):(e.writeUint32(r.segment_duration),e.writeInt32(r.media_time)),e.writeInt16(r.media_rate_integer),e.writeInt16(r.media_rate_fraction)}}};kr.fourcc="elst";var Tr=class extends f{constructor(){super(...arguments);this.box_name="EventMessageBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.timescale=e.readUint32(),this.presentation_time=e.readUint64(),this.event_duration=e.readUint32(),this.id=e.readUint32(),this.scheme_id_uri=e.readCString(),this.value=e.readCString()):(this.scheme_id_uri=e.readCString(),this.value=e.readCString(),this.timescale=e.readUint32(),this.presentation_time_delta=e.readUint32(),this.event_duration=e.readUint32(),this.id=e.readUint32());let i=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version===1&&(i-=4),this.message_data=e.readUint8Array(i)}write(e){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(e),e.writeCString(this.scheme_id_uri),e.writeCString(this.value),e.writeUint32(this.timescale),e.writeUint32(this.presentation_time_delta),e.writeUint32(this.event_duration),e.writeUint32(this.id),e.writeUint8Array(this.message_data)}};Tr.fourcc="emsg";var z=class extends f{parse(t){this.parseFullHeader(t),this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(let e=0;e<this.num_entities_in_group;e++){let i=t.readUint32();this.entity_ids.push(i)}}};var Fr=class extends z{constructor(){super(...arguments);this.box_name="Auto exposure bracketing"}};Fr.fourcc="aebr";var Er=class extends z{constructor(){super(...arguments);this.box_name="Flash exposure information"}};Er.fourcc="afbr";var Dr=class extends z{constructor(){super(...arguments);this.box_name="Album collection"}};Dr.fourcc="albc";var Pr=class extends z{constructor(){super(...arguments);this.box_name="Alternative entity"}};Pr.fourcc="altr";var Lr=class extends z{constructor(){super(...arguments);this.box_name="Burst image"}};Lr.fourcc="brst";var Cr=class extends z{constructor(){super(...arguments);this.box_name="Depth of field bracketing"}};Cr.fourcc="dobr";var Nr=class extends z{constructor(){super(...arguments);this.box_name="Equivalent entity"}};Nr.fourcc="eqiv";var Rr=class extends z{constructor(){super(...arguments);this.box_name="Favorites collection"}};Rr.fourcc="favc";var Or=class extends z{constructor(){super(...arguments);this.box_name="Focus bracketing"}};Or.fourcc="fobr";var Hr=class extends z{constructor(){super(...arguments);this.box_name="Image item with an audio track"}};Hr.fourcc="iaug";var Vr=class extends z{constructor(){super(...arguments);this.box_name="Panorama"}};Vr.fourcc="pano";var Gr=class extends z{constructor(){super(...arguments);this.box_name="Slideshow"}};Gr.fourcc="slid";var jr=class extends z{constructor(){super(...arguments);this.box_name="Stereo"}};jr.fourcc="ster";var Kr=class extends z{constructor(){super(...arguments);this.box_name="Time-synchronized capture"}};Kr.fourcc="tsyn";var qr=class extends z{constructor(){super(...arguments);this.box_name="White balance bracketing"}};qr.fourcc="wbbr";var Yr=class extends z{constructor(){super(...arguments);this.box_name="Progressive rendering"}};Yr.fourcc="prgr";var $r=class extends z{constructor(){super(...arguments);this.box_name="Image pyramid"}parse(e){this.parseFullHeader(e),this.group_id=e.readUint32(),this.num_entities_in_group=e.readUint32(),this.entity_ids=[];for(let i=0;i<this.num_entities_in_group;i++){let r=e.readUint32();this.entity_ids.push(r)}this.tile_size_x=e.readUint16(),this.tile_size_y=e.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[];for(let i=0;i<this.num_entities_in_group;i++)this.layer_binning[i]=e.readUint16(),this.tiles_in_layer_row_minus1[i]=e.readUint16(),this.tiles_in_layer_column_minus1[i]=e.readUint16()}};$r.fourcc="pymd";var Wr=class extends c{constructor(){super(...arguments);this.box_name="FieldHandlingBox"}parse(e){this.fieldCount=e.readUint8(),this.fieldOrdering=e.readUint8()}};Wr.fourcc="fiel";var Zr=class extends c{constructor(){super(...arguments);this.box_name="OriginalFormatBox"}parse(e){this.data_format=e.readString(4)}};Zr.fourcc="frma";var Xr=class extends c{constructor(){super(...arguments);this.box_name="ImageMirror"}parse(e){let i=e.readUint8();this.reserved=i>>7,this.axis=i&1}};Xr.fourcc="imir";var Jr=class extends f{constructor(){super(...arguments);this.box_name="ItemPropertyAssociationBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.associations=[];for(let r=0;r<i;r++){let n=this.version<1?e.readUint16():e.readUint32(),o=[],a=e.readUint8();for(let l=0;l<a;l++){let d=e.readUint8();o.push({essential:(d&128)>>7===1,property_index:this.flags&1?(d&127)<<8|e.readUint8():d&127})}this.associations.push({id:n,props:o})}}};Jr.fourcc="ipma";var Qr=class extends c{constructor(){super(...arguments);this.box_name="ImageRotation"}parse(e){this.angle=e.readUint8()&3}};Qr.fourcc="irot";var es=class extends f{constructor(){super(...arguments);this.box_name="ImageSpatialExtentsProperty"}parse(e){this.parseFullHeader(e),this.image_width=e.readUint32(),this.image_height=e.readUint32()}};es.fourcc="ispe";var ts=class extends f{constructor(){super(...arguments);this.box_name="TAITimestampBox"}parse(e){this.TAI_timestamp=e.readUint64();let i=e.readUint8();this.sychronization_state=i>>7&1,this.timestamp_generation_failure=i>>6&1,this.timestamp_is_modified=i>>5&1}};ts.fourcc="itai";var is=class extends f{constructor(){super(...arguments);this.box_name="KindBox"}parse(e){this.parseFullHeader(e),this.schemeURI=e.readCString(),this.isEndOfBox(e)||(this.value=e.readCString())}write(e){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value?this.value.length+1:0),this.writeHeader(e),e.writeCString(this.schemeURI),this.value&&e.writeCString(this.value)}};is.fourcc="kind";var rs=class extends f{constructor(){super(...arguments);this.box_name="LevelAssignmentBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8();this.levels=[];for(let r=0;r<i;r++){let n={};this.levels[r]=n,n.track_ID=e.readUint32();let o=e.readUint8();switch(n.padding_flag=o>>7,n.assignment_type=o&127,n.assignment_type){case 0:n.grouping_type=e.readString(4);break;case 1:n.grouping_type=e.readString(4),n.grouping_type_parameter=e.readUint32();break;case 2:break;case 3:break;case 4:n.sub_track_id=e.readUint32();break;default:u.warn("BoxParser",`Unknown level assignment type: ${n.assignment_type}`)}}}};rs.fourcc="leva";var ss=class extends c{constructor(){super(...arguments);this.box_name="LHEVCConfigurationBox"}parse(e){this.configurationVersion=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3;let i=e.readUint8();this.numTemporalLayers=(i&13)>>3,this.temporalIdNested=(i&4)>>2,this.lengthSizeMinusOne=i&3,this.nalu_arrays=[];let r=e.readUint8();for(let n=0;n<r;n++){let o=[];this.nalu_arrays.push(o),i=e.readUint8(),o.completeness=(i&128)>>7,o.nalu_type=i&63;let a=e.readUint16();for(let l=0;l<a;l++){let d=e.readUint16();o.push({data:e.readUint8Array(d)})}}}};ss.fourcc="lhvC";var ns=class extends c{constructor(){super(...arguments);this.box_name="LayerSelectorProperty"}parse(e){this.layer_id=e.readUint16()}};ns.fourcc="lsel";var os=class extends c{constructor(){super(...arguments);this.box_name="hintmaxrate"}parse(e){this.period=e.readUint32(),this.bytes=e.readUint32()}};os.fourcc="maxr";var fe=class{constructor(t,e){this.x=t;this.y=e}toString(){return"("+this.x+","+this.y+")"}};var as=class extends c{constructor(){super(...arguments);this.box_name="MasteringDisplayColourVolumeBox"}parse(e){this.display_primaries=[],this.display_primaries[0]=new fe(e.readUint16(),e.readUint16()),this.display_primaries[1]=new fe(e.readUint16(),e.readUint16()),this.display_primaries[2]=new fe(e.readUint16(),e.readUint16()),this.white_point=new fe(e.readUint16(),e.readUint16()),this.max_display_mastering_luminance=e.readUint32(),this.min_display_mastering_luminance=e.readUint32()}};as.fourcc="mdcv";var fs=class extends f{constructor(){super(...arguments);this.box_name="MovieFragmentRandomAccessOffsetBox"}parse(e){this.parseFullHeader(e),this._size=e.readUint32()}};fs.fourcc="mfro";var ls=class extends f{constructor(){super(...arguments);this.box_name="MaskConfigurationProperty"}parse(e){this.parseFullHeader(e),this.bits_per_pixel=e.readUint8()}};ls.fourcc="mskC";var ds=class extends c{constructor(){super(...arguments);this.box_name="hintPacketsSent"}parse(e){this.packetssent=e.readUint32()}};ds.fourcc="npck";var us=class extends c{constructor(){super(...arguments);this.box_name="hintPacketsSent"}parse(e){this.packetssent=e.readUint64()}};us.fourcc="nump";var eo=class{constructor(t,e){this.pad1=t;this.pad2=e}},cs=class extends f{constructor(){super(...arguments);this.box_name="PaddingBitsBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.padbits=[];for(let r=0;r<Math.floor((i+1)/2);r++){let n=e.readUint8(),o=(n&112)>>4,a=n&7;this.padbits.push(new eo(o,a))}}};cs.fourcc="padb";var ps=class extends c{constructor(){super(...arguments);this.box_name="PixelAspectRatioBox"}parse(e){this.hSpacing=e.readUint32(),this.vSpacing=e.readUint32()}};ps.fourcc="pasp";var ms=class extends c{constructor(){super(...arguments);this.box_name="CuePayloadBox"}parse(e){this.text=e.readString(this.size-this.hdr_size)}};ms.fourcc="payl";var hs=class extends c{constructor(){super(...arguments);this.box_name="hintpayloadID"}parse(e){this.payloadID=e.readUint32();let i=e.readUint8();this.rtpmap_string=e.readString(i)}};hs.fourcc="payt";var _s=class extends f{constructor(){super(...arguments);this.box_name="ProgressiveDownloadInfoBox";this.rate=[];this.initial_delay=[]}parse(e){this.parseFullHeader(e);let i=(this.size-this.hdr_size)/8;for(let r=0;r<i;r++)this.rate[r]=e.readUint32(),this.initial_delay[r]=e.readUint32()}};_s.fourcc="pdin";var bs=class extends f{constructor(){super(...arguments);this.box_name="PixelInformationProperty"}parse(e){this.parseFullHeader(e),this.num_channels=e.readUint8(),this.bits_per_channels=[];for(let i=0;i<this.num_channels;i++)this.bits_per_channels[i]=e.readUint8()}};bs.fourcc="pixi";var xs=class extends c{constructor(){super(...arguments);this.box_name="hintlargestpacket"}parse(e){this.bytes=e.readUint32()}};xs.fourcc="pmax";var ys=class extends f{constructor(){super(...arguments);this.box_name="ProgressiveDerivedImageItemInformationProperty"}parse(e){if(this.parseFullHeader(e),this.step_count=e.readUint16(),this.item_count=[],this.flags&2)for(let i=0;i<this.step_count;i++)this.item_count[i]=e.readUint16()}};ys.fourcc="prdi";var gs=class extends f{constructor(){super(...arguments);this.box_name="ProducerReferenceTimeBox"}parse(e){this.parseFullHeader(e),this.ref_track_id=e.readUint32(),this.ntp_timestamp=e.readUint64(),this.version===0?this.media_time=e.readUint32():this.media_time=e.readUint64()}};gs.fourcc="prft";var Ss=class extends f{constructor(){super(...arguments);this.box_name="ProtectionSystemSpecificHeaderBox"}parse(e){if(this.parseFullHeader(e),this.system_id=G(e),this.version>0){let r=e.readUint32();this.kid=[];for(let n=0;n<r;n++)this.kid[n]=G(e)}let i=e.readUint32();i>0&&(this.protection_data=e.readUint8Array(i))}};Ss.fourcc="pssh";var Bs=class extends f{constructor(){super(...arguments);this.box_name="TrackCleanApertureDimensionsBox"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};Bs.fourcc="clef";var Us=class extends f{constructor(){super(...arguments);this.box_name="TrackEncodedPixelsDimensionsBox"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};Us.fourcc="enof";var ws=class extends f{constructor(){super(...arguments);this.box_name="TrackProductionApertureDimensionsBox"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};ws.fourcc="prof";var As=class extends x{constructor(){super(...arguments);this.box_name="TrackApertureModeDimensionsBox";this.clefs=[];this.profs=[];this.enofs=[];this.subBoxNames=["clef","prof","enof"]}};As.fourcc="tapt";var vs=class extends c{constructor(){super(...arguments);this.box_name="rtpmoviehintinformation"}parse(e){this.descriptionformat=e.readString(4),this.sdptext=e.readString(this.size-this.hdr_size-4)}};vs.fourcc="rtp ";var Ms=class extends f{constructor(){super(...arguments);this.box_name="SampleAuxiliaryInformationOffsetsBox"}parse(e){this.parseFullHeader(e),this.flags&1&&(this.aux_info_type=e.readString(4),this.aux_info_type_parameter=e.readUint32());let i=e.readUint32();this.offset=[];for(let r=0;r<i;r++)this.version===0?this.offset[r]=e.readUint32():this.offset[r]=e.readUint64()}};Ms.fourcc="saio";var Is=class extends f{constructor(){super(...arguments);this.box_name="SampleAuxiliaryInformationSizesBox"}parse(e){if(this.parseFullHeader(e),this.flags&1&&(this.aux_info_type=e.readString(4),this.aux_info_type_parameter=e.readUint32()),this.default_sample_info_size=e.readUint8(),this.sample_count=e.readUint32(),this.sample_info_size=[],this.default_sample_info_size===0)for(let i=0;i<this.sample_count;i++)this.sample_info_size[i]=e.readUint8()}};Is.fourcc="saiz";var zs=class{constructor(t,e){this.bad_pixel_row=t;this.bad_pixel_column=e}toString(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"}};var ks=class extends f{constructor(){super(...arguments);this.box_name="SensorBadPixelsMapBox"}parse(e){this.parseFullHeader(e),this.component_count=e.readUint16(),this.component_index=[];for(let r=0;r<this.component_count;r++)this.component_index.push(e.readUint16());let i=e.readUint8();this.correction_applied=(i&128)===128,this.num_bad_rows=e.readUint32(),this.num_bad_cols=e.readUint32(),this.num_bad_pixels=e.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[];for(let r=0;r<this.num_bad_rows;r++)this.bad_rows.push(e.readUint32());for(let r=0;r<this.num_bad_cols;r++)this.bad_columns.push(e.readUint32());for(let r=0;r<this.num_bad_pixels;r++){let n=e.readUint32(),o=e.readUint32();this.bad_pixels.push(new zs(n,o))}}};ks.fourcc="sbpm";var Ts=class extends f{constructor(){super(...arguments);this.box_name="SchemeTypeBox"}parse(e){this.parseFullHeader(e),this.scheme_type=e.readString(4),this.scheme_version=e.readUint32(),this.flags&1&&(this.scheme_uri=e.readString(this.size-this.hdr_size-8))}};Ts.fourcc="schm";var Fs=class extends c{constructor(){super(...arguments);this.box_name="rtptracksdphintinformation"}parse(e){this.sdptext=e.readString(this.size-this.hdr_size)}};Fs.fourcc="sdp ";var Es=class extends f{constructor(){super(...arguments);this.box_name="SampleEncryptionBox"}};Es.fourcc="senc";var Ds=class extends f{constructor(){super(...arguments);this.box_name="SMPTE2086MasteringDisplayMetadataBox"}parse(e){this.parseFullHeader(e),this.primaryRChromaticity_x=e.readUint16(),this.primaryRChromaticity_y=e.readUint16(),this.primaryGChromaticity_x=e.readUint16(),this.primaryGChromaticity_y=e.readUint16(),this.primaryBChromaticity_x=e.readUint16(),this.primaryBChromaticity_y=e.readUint16(),this.whitePointChromaticity_x=e.readUint16(),this.whitePointChromaticity_y=e.readUint16(),this.luminanceMax=e.readUint32(),this.luminanceMin=e.readUint32()}};Ds.fourcc="SmDm";var Ps=class extends f{constructor(){super(...arguments);this.box_name="CompressedSubsegmentIndexBox"}parse(e){this.parseFullHeader(e),this.subsegments=[];let i=e.readUint32();for(let r=0;r<i;r++){let n={};this.subsegments.push(n),n.ranges=[];let o=e.readUint32();for(let a=0;a<o;a++){let l={};n.ranges.push(l),l.level=e.readUint8(),l.range_size=e.readUint24()}}}};Ps.fourcc="ssix";var Ls=class extends f{constructor(){super(...arguments);this.box_name="DegradationPriorityBox"}parse(e){this.parseFullHeader(e);let i=(this.size-this.hdr_size)/2;this.priority=[];for(let r=0;r<i;r++)this.priority[r]=e.readUint16()}};Ls.fourcc="stpd";var Cs=class extends f{constructor(){super(...arguments);this.box_name="SubTrackInformationBox"}parse(e){this.parseFullHeader(e),this.switch_group=e.readUint16(),this.alternate_group=e.readUint16(),this.sub_track_id=e.readUint32();let i=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(let r=0;r<i;r++)this.attribute_list[r]=e.readUint32()}};Cs.fourcc="stri";var Ns=class extends f{constructor(){super(...arguments);this.box_name="SubTrackSampleGroupBox"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readUint32();let i=e.readUint16();this.group_description_index=[];for(let r=0;r<i;r++)this.group_description_index[r]=e.readUint32()}};Ns.fourcc="stsg";var Rs=class extends f{constructor(){super(...arguments);this.box_name="ShadowSyncSampleBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(let r=0;r<i;r++)this.shadowed_sample_numbers.push(e.readUint32()),this.sync_sample_numbers.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(e),e.writeUint32(this.shadowed_sample_numbers.length);for(let i=0;i<this.shadowed_sample_numbers.length;i++)e.writeUint32(this.shadowed_sample_numbers[i]),e.writeUint32(this.sync_sample_numbers[i])}};Rs.fourcc="stsh";var Os=class extends f{constructor(){super(...arguments);this.box_name="SyncSampleBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.version===0){this.sample_numbers=[];for(let r=0;r<i;r++)this.sample_numbers.push(e.readUint32())}}write(e){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(e),e.writeUint32(this.sample_numbers.length),e.writeUint32Array(this.sample_numbers)}};Os.fourcc="stss";var Hs=class extends f{constructor(){super(...arguments);this.box_name="StereoVideoBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.single_view_allowed=i&3,this.stereo_scheme=e.readUint32();let r=e.readUint32();for(this.stereo_indication_type=e.readString(r),this.boxes=[];e.getPosition()<this.start+this.size;){let n=I(e,!1,this.size-(e.getPosition()-this.start));if(n.code===v){let o=n.box;this.boxes.push(o),this[o.type]=o}else return}}};Hs.fourcc="stvi";var Vs=class extends c{constructor(){super(...arguments);this.box_name="SegmentTypeBox"}parse(e){let i=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),i-=8,this.compatible_brands=[];let r=0;for(;i>=4;)this.compatible_brands[r]=e.readString(4),i-=4,r++}write(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,null,4),e.writeUint32(this.minor_version);for(let i=0;i<this.compatible_brands.length;i++)e.writeString(this.compatible_brands[i],null,4)}};Vs.fourcc="styp";var Gs=class extends f{constructor(){super(...arguments);this.box_name="CompactSampleSizeBox"}parse(e){if(this.parseFullHeader(e),this.sample_sizes=[],this.version===0){this.reserved=e.readUint24(),this.field_size=e.readUint8();let i=e.readUint32();if(this.field_size===4)for(let r=0;r<i;r+=2){let n=e.readUint8();this.sample_sizes[r]=n>>4&15,this.sample_sizes[r+1]=n&15}else if(this.field_size===8)for(let r=0;r<i;r++)this.sample_sizes[r]=e.readUint8();else if(this.field_size===16)for(let r=0;r<i;r++)this.sample_sizes[r]=e.readUint16();else u.error("BoxParser","Error in length field in stz2 box")}}};Gs.fourcc="stz2";var js=class extends f{constructor(){super(...arguments);this.box_name="SubSampleInformationBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.entries=[];let r;for(let n=0;n<i;n++){let o={};if(this.entries[n]=o,o.sample_delta=e.readUint32(),o.subsamples=[],r=e.readUint16(),r>0)for(let a=0;a<r;a++){let l={};o.subsamples.push(l),this.version===1?l.size=e.readUint32():l.size=e.readUint16(),l.priority=e.readUint8(),l.discardable=e.readUint8(),l.codec_specific_parameters=e.readUint32()}}}};js.fourcc="subs";var Ks=class extends f{constructor(){super(...arguments);this.box_name="TAIClockInfoBox"}parse(e){this.time_uncertainty=e.readUint64(),this.clock_resolution=e.readUint32(),this.clock_drift_rate=e.readInt32();let i=e.readUint8();this.clock_type=(i&192)>>6}};Ks.fourcc="taic";var qs=class extends f{constructor(){super(...arguments);this.box_name="TrackEncryptionBox"}parse(e){if(this.parseFullHeader(e),e.readUint8(),this.version===0)e.readUint8();else{let i=e.readUint8();this.default_crypt_byte_block=i>>4&15,this.default_skip_byte_block=i&15}this.default_isProtected=e.readUint8(),this.default_Per_Sample_IV_Size=e.readUint8(),this.default_KID=G(e),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=e.readUint8(),this.default_constant_IV=e.readUint8Array(this.default_constant_IV_size))}};qs.fourcc="tenc";var Ys=class extends f{constructor(){super(...arguments);this.box_name="TrackFragmentRandomAccessBox"}parse(e){this.parseFullHeader(e),this.track_ID=e.readUint32(),e.readUint24();let i=e.readUint8();this.length_size_of_traf_num=i>>4&3,this.length_size_of_trun_num=i>>2&3,this.length_size_of_sample_num=i&3,this.entries=[];let r=e.readUint32();for(let n=0;n<r;n++)this.version===1?(this.time=e.readUint64(),this.moof_offset=e.readUint64()):(this.time=e.readUint32(),this.moof_offset=e.readUint32()),this.traf_number=e["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=e["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=e["readUint"+8*(this.length_size_of_sample_num+1)]()}};Ys.fourcc="tfra";var $s=class extends c{constructor(){super(...arguments);this.box_name="hintmaxrelativetime"}parse(e){this.time=e.readUint32()}};$s.fourcc="tmax";var Ws=class extends c{constructor(){super(...arguments);this.box_name="hintminrelativetime"}parse(e){this.time=e.readUint32()}};Ws.fourcc="tmin";var Zs=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint32()}};Zs.fourcc="totl";var Xs=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint32()}};Xs.fourcc="tpay";var Js=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint64()}};Js.fourcc="tpyl";var Qs=class extends tt{};Qs.fourcc="msrc";var ut=class ut extends c{constructor(){super(...arguments);this.box_name="TrackReferenceBox";this.references=[]}parse(e){for(;e.getPosition()<this.start+this.size;){let i=I(e,!0,this.size-(e.getPosition()-this.start));if(i.code===v){ut.allowed_types.includes(i.type)||u.warn("BoxParser",`Unknown track reference type: '${i.type}'`);let r=new st(i.type,i.size,i.hdr_size,i.start);r.write===c.prototype.write&&r.type!=="mdat"&&(u.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(e)),r.parse(e),this.references.push(r)}else return}}};ut.fourcc="tref",ut.allowed_types=["hint","cdsc","font","hind","vdep","vplx","subt","thmb","auxl","cdtg","shsc","aest"];var to=ut;var en=class extends f{constructor(){super(...arguments);this.box_name="TrackExtensionPropertiesBox"}parse(e){for(this.parseFullHeader(e),this.track_ID=e.readUint32(),this.boxes=[];e.getPosition()<this.start+this.size;){let i=I(e,!1,this.size-(e.getPosition()-this.start));if(i.code===v){let r=i.box;this.boxes.push(r)}else return}}};en.fourcc="trep";var tn=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint64()}};tn.fourcc="trpy";var rn=class extends f{constructor(){super(...arguments);this.box_name="TrackSelectionBox"}parse(e){this.parseFullHeader(e),this.switch_group=e.readUint32();let i=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(let r=0;r<i;r++)this.attribute_list[r]=e.readUint32()}};rn.fourcc="tsel";var sn=class extends f{constructor(){super(...arguments);this.box_name="TextConfigBox"}parse(e){this.parseFullHeader(e),this.config=e.readCString()}};sn.fourcc="txtc";var nn=class extends c{constructor(){super(...arguments);this.box_name="TypeCombinationBox"}parse(e){let i=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(let r=0;r<i;r++)this.compatible_brands[r]=e.readString(4)}};nn.fourcc="tyco";var on=class extends f{constructor(){super(...arguments);this.box_name="UserDescriptionProperty"}parse(e){this.parseFullHeader(e),this.lang=e.readCString(),this.name=e.readCString(),this.description=e.readCString(),this.tags=e.readCString()}};on.fourcc="udes";var an=class extends f{constructor(){super(...arguments);this.box_name="UncompressedFrameConfigBox"}parse(e){if(this.parseFullHeader(e),this.profile=e.readString(4),this.version!==1){if(this.version===0){this.component_count=e.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[];for(let r=0;r<this.component_count;r++)this.component_index.push(e.readUint16()),this.component_bit_depth_minus_one.push(e.readUint8()),this.component_format.push(e.readUint8()),this.component_align_size.push(e.readUint8());this.sampling_type=e.readUint8(),this.interleave_type=e.readUint8(),this.block_size=e.readUint8();let i=e.readUint8();this.component_little_endian=i>>7&1,this.block_pad_lsb=i>>6&1,this.block_little_endian=i>>5&1,this.block_reversed=i>>4&1,this.pad_unknown=i>>3&1,this.pixel_size=e.readUint32(),this.row_align_size=e.readUint32(),this.tile_align_size=e.readUint32(),this.num_tile_cols_minus_one=e.readUint32(),this.num_tile_rows_minus_one=e.readUint32()}}}};an.fourcc="uncC";var fn=class extends f{constructor(){super(...arguments);this.box_name="DataEntryUrnBox"}parse(e){this.parseFullHeader(e),this.name=e.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=e.readCString())}write(e){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(e),e.writeCString(this.name),this.location&&e.writeCString(this.location)}};fn.fourcc="urn ";var ln=class extends c{constructor(){super(...arguments);this.box_name="WebVTTConfigurationBox"}parse(e){this.text=e.readString(this.size-this.hdr_size)}};ln.fourcc="vttC";var dn=class extends f{constructor(){super(...arguments);this.box_name="VvcNALUConfigBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8();this.lengthSizeMinusOne=i&3}};dn.fourcc="vvnC";var un=class extends b{parse(t){let e=t.readUint16();this.first_output_sample=t.readUint16(),this.sample_offset=[];for(let r=0;r<e;r++)this.sample_offset[r]=t.readUint32();let i=this.description_length-4-4*e;this.num_output_samples=[],this.num_total_samples=[];for(let r=0;r<i/4;r++)this.num_output_samples[r]=t.readUint16(),this.num_total_samples[r]=t.readUint16()}};un.grouping_type="alst";var cn=class extends b{parse(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}};cn.grouping_type="avll";var pn=class extends b{parse(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();let e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];let i=t.readUint8();for(let r=0;r<i;r++)this.dependency.push({subSeqDirectionFlag:t.readUint8(),layerNumber:t.readUint8(),subSequenceIdentifier:t.readUint16()})}};pn.grouping_type="avss";var mn=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};mn.grouping_type="dtrt";var hn=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};hn.grouping_type="mvif";var _n=class extends b{parse(t){this.roll_distance=t.readInt16()}};_n.grouping_type="prol";var bn=class extends b{parse(t){let e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}};bn.grouping_type="rap ";var xn=class extends b{parse(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)u.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(let e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}};xn.grouping_type="rash";var yn=class extends b{parse(t){this.roll_distance=t.readInt16()}};yn.grouping_type="roll";var gn=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};gn.grouping_type="scif";var Sn=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Sn.grouping_type="scnm";var Bn=class extends b{parse(t){this.reserved=t.readUint8();let e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=G(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}};Bn.grouping_type="seig";var Un=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Un.grouping_type="stsa";var wn=class extends b{parse(t){let e=t.readUint8();this.NAL_unit_type=e&63}};wn.grouping_type="sync";var An=class extends b{parse(t){let e=t.readUint8();this.level_independently_decodable=e>>7}};An.grouping_type="tele";var vn=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};vn.grouping_type="tsas";var Mn=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Mn.grouping_type="tscl";var In=class extends b{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};In.grouping_type="vipr";var zn=class extends c{};zn.fourcc="uuid";var W=class extends f{};W.fourcc="uuid";var kn=class extends W{constructor(){super(...arguments);this.box_name="LiveServerManifestBox"}parse(e){this.parseFullHeader(e),this.LiveServerManifest=e.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}};kn.uuid="a5d40b30e81411ddba2f0800200c9a66";var Tn=class extends W{constructor(){super(...arguments);this.box_name="PiffProtectionSystemSpecificHeaderBox"}parse(e){this.parseFullHeader(e),this.system_id=G(e);let i=e.readUint32();i>0&&(this.data=e.readUint8Array(i))}};Tn.uuid="d08a4f1810f34a82b6c832d8aba183d3";var Fn=class extends W{constructor(){super(...arguments);this.box_name="PiffSampleEncryptionBox"}};Fn.uuid="a2394f525a9b4f14a2446c427c648df4";var En=class extends W{constructor(){super(...arguments);this.box_name="PiffTrackEncryptionBox"}parse(e){this.parseFullHeader(e),this.default_AlgorithmID=e.readUint24(),this.default_IV_size=e.readUint8(),this.default_KID=G(e)}};En.uuid="8974dbce7be74c5184f97148f9882554";var Dn=class extends W{constructor(){super(...arguments);this.box_name="TfrfBox"}parse(e){this.parseFullHeader(e),this.fragment_count=e.readUint8(),this.entries=[];for(let i=0;i<this.fragment_count;i++){let r=0,n=0;this.version===1?(r=e.readUint64(),n=e.readUint64()):(r=e.readUint32(),n=e.readUint32()),this.entries.push({absolute_time:r,absolute_duration:n})}}};Dn.uuid="d4807ef2ca3946958e5426cb9e46a79f";var Pn=class extends W{constructor(){super(...arguments);this.box_name="TfxdBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.absolute_time=e.readUint64(),this.duration=e.readUint64()):(this.absolute_time=e.readUint32(),this.duration=e.readUint32())}};Pn.uuid="6d1d9b0542d544e680e2141daff757b2";var Ln=class extends zn{constructor(){super(...arguments);this.box_name="ItemContentIDProperty"}parse(e){this.content_id=e.readCString()}};Ln.uuid="261ef3741d975bbaacbd9d2c8ea73522";var Eo=_o(io);bo(Zn);return wo(Do);})();
//# sourceMappingURL=mp4box.all.global.js.map