<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="../lib/style.css" />
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
  </head>

  <body>
    <div id="content-wrapper">
      <div id="video-wrapper">
      <video></video>
      <!--<img src="https://user-images.githubusercontent.com/9865551/103573789-202dc780-4ecf-11eb-816b-7264d15a3c86.png" />-->
      <div><div id="qr-code"></div></div>
      </div>
      <div>Press Enter/Ok to continue or Up/Down to show/hide debug overlay</div>
      <div id="debug"></div>
      <div id="log"></div>
    </div>
    <div id="info-overlay"></div>
    <script src="../lib/mozilla/object-keys-polyfill.js"></script>
    <script src="../lib/stefanpenner/es6-promise.min.js"></script>
    <script src="../lib/player.js"></script>
    <script src="../lib/manifest_parser.js"></script>
    <script src="../lib/mpd-parser.js"></script>
    <script src="../lib/wave-service.js"></script>
    <script src="../lib/davidshimjs/qrcode.js"></script>
    <script src="../lib/dpctf-testharness.js"></script>
    <script>
      // Global variables
      var TEST_INFO = {
        id: "sequential-track-playback",
        title: "Sequential Track Playback",
        description:
          "Sequential track playback refers to the case that a CMAF/WAVE track is played from the beginning by providing CMAF fragments to the source buffer after initialization.",
        path: "Folder1/sequential-track-playback-manual__ToS_MultiRate_chunked__ToS_HEAACv2_fragmented.html",
        code: "sequential-track-playback-manual.html",
        observations: [
          {
            name: "Low start-up delay",
            description:
              "The start-up delay should be sufficiently low, i.e., TR [k, 1] â€“ Ti < TSMax.",
            id: "start-up-delay",
          },
          {
            name: "Render every sample",
            description:
              "Every sample S[k,s] shall be rendered and the samples shall be rendered in increasing presentation time order.",
            id: "every-sample-rendered",
          },
          {
            name: "Duration matches CMAF track",
            description:
              "The playback duration of the playback matches the duration of the CMAF Track, i.e. TR[k, S] = TR [k, 1] + td[k].",
            id: "duration-matches-cmaf-track",
          },
          {
            name: "Presented sample correct",
            description:
              "The presented sample matches the one reported by the currentTime value within the tolerance of the sample duration.",
            id: "sample-matches-current-time",
          },
          {
            name: "Video rendered in entire window",
            description:
              "Every video frame S[k,s] shall be rendered such that it fills the entire video output window.",
            id: "video-fills-entire-output-window",
          },
        ],
      };

      var video = document.querySelector("video");
      var qrCode = document.getElementById("qr-code");

      var videoContentModel = "http://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Chunked/ToS_MultiRate_chunked.mpd";
      var audioContentModel = "https://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Fragmented/ToS_HEAACv2_fragmented.mpd";

      new DpctfTest({
        testInfo: TEST_INFO,
        videoContentModel: videoContentModel,
        audioContentModel: audioContentModel,
        videoElement: video,
        qrCodeElement: qrCode,
        infoOverlayElement: document.getElementById("info-overlay"),
        executeTest: executeTest,
      });

      function executeTest(player, done, parameters) {
        var minBufferDuration = parameters.minBufferDuration / 1000;
        player.startBuffering();
        if (player.getPreBufferedTime() >= minBufferDuration) {
          player.play();
        } else {
          player.on("onVideoSegmentLoaded", function (event) {
            if (player.getPreBufferedTime() >= minBufferDuration) {
              player.play();
            }
          });
        }

        async_test(function (test) {
          video.addEventListener(
            "play",
            test.step_func(function (event) {
              if (video.paused) return;
              assert_true(true);
              test.done();
            })
          );
        }, "Playback starts");

        async_test(function (test) {
          var count = 0;
          video.addEventListener(
            "timeupdate",
            test.step_func(function (event) {
              count += 1;
              if (count < 5) return;
              assert_true(true);
              test.done();
            })
          );
        }, "5 time update events fired");

        done();
      }
    </script>
  </body>
</html>
