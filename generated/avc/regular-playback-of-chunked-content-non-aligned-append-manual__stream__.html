<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="../lib/style.css" />
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
  </head>

  <body>
    <div id="content-wrapper">
      <div id="video-wrapper">
      <video></video>
      <div><div id="qr-code"></div></div>
      </div>
      <div>Press Enter/Ok to continue or Up/Down to show/hide debug overlay</div>
      <div id="debug"></div>
      <div id="log"></div>
    </div>
    <div id="info-overlay"></div>
    <script src="../lib/mozilla/object-keys-polyfill.js"></script>
    <script src="../lib/stefanpenner/es6-promise.min.js"></script>
    <script src="../lib/player.js"></script>
    <script src="../lib/manifest_parser.js"></script>
    <script src="../lib/mpd-parser.js"></script>
    <script src="../lib/wave-service.js"></script>
    <script src="../lib/davidshimjs/qrcode.js"></script>
    <script src="../lib/dpctf-testharness.js"></script>
    <script>
      // Global variables
      var TEST_INFO = {
        title: "Regular Playback of Chunked Content, non-aligned append",
        description:
          "Sequential Chunked Playback refers to the case that a CMAF/WAVE track is played from the beginning by providing CMAF chunks to the source buffer after initialization.  Non-aligned refers to the situation where the data that is appended to the source buffer is appended progressively in pieces that do not necessarily align with the boundaries of the CMAF chunks.",
        path: "avc/regular-playback-of-chunked-content-non-aligned-append-manual__stream__.html",
        code: "regular-playback-of-chunked-content-non-aligned-append-manual.html",
        params: urlParams,
        observations: [],
      };
      var video = document.querySelector("video");
      var qrCode = document.getElementById("qr-code");

      var videoContentModel = "https://dash.akamaized.net/WAVE/vectors/avc_sets/1/stream.mpd";
      var audioContentModel = "";

      var dpctfTest = new DpctfTest({
        testInfo: TEST_INFO,
        videoContentModel: videoContentModel,
        audioContentModel: audioContentModel,
        videoElement: video,
        qrCodeElement: qrCode,
        infoOverlayElement: document.getElementById("info-overlay"),
        executeTest: executeTest,
      });

      function executeTest(player, done, parameters) {
        var minBufferDuration = parameters.minBufferDuration / 1000;
        player.startBuffering();
        if (player.getPreBufferedTime() >= minBufferDuration) {
          player.play();
        } else {
          player.on("onVideoSegmentLoaded", function (event) {
            if (player.getPreBufferedTime() >= minBufferDuration) {
              player.play();
            }
          });
        }

        dpctfTest.asyncTest(function (test) {
          var query = location.search.replace(/\?/, "");
          var match = query.match(/redirect_time=([^&]+)/);
          var REDIRECT_TIME = match ? match[1] : null;
          if (!REDIRECT_TIME) REDIRECT_TIME = 5;
          video.addEventListener(
            "ended",
            function (event) {
              setTimeout(test.step_func(function () {
                assert_true(true);
                test.done();
              }), REDIRECT_TIME * 1000);
            }
          );
        }, "video ended event fired");

        done();
      }
    </script>
  </body>
</html>
