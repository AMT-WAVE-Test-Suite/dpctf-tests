<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
  </head>

  <body>
    <video style="height: 400px;"></video>
    <div>Press Enter/Ok to continue or Up/Down to show/hide debug overlay</div>
    <div id="debug"></div>
    <div id="log"></div>
    <div id="info-overlay"></div>
    <script src="lib/mozilla/object-keys-polyfill.js"></script>
    <script src="lib/stefanpenner/es6-promise.min.js"></script>
    <script src="lib/utils/test_helper.js"></script>
    <script src="lib/player.js"></script>
    <script src="lib/manifest_parser.js"></script>
    <script src="lib/mpd-parser.js"></script>
    <script src="lib/info-overlay.js"></script>
    <script src="lib/wave-service.js"></script>
    <script>
      // Global variables
      var TEST_INFO = {
        title:
          "Sequential Playback of Encrypted and Non-Encrypted Baseline Content",
        description: "",
        path: location.pathname,
        params: urlParams,
        observations: [],
      };

      var waveService = null;
      var video = null;
      var player = null;

      // Specify workflow
      setupTest()
        .then(initializeWaveService)
        .then(sendTestReadyEvent)
        .then(waitForObservationReady)
        .then(executeTest)
        .then(handleError);

      function handleError(error) {
        if (!error) return;
        throw new Error(error);
      }

      function setupTest(error) {
        if (error) return error;
        return new Promise(function (resolve) {
          //// Meta Info ////
          document.getElementsByTagName("title")[0].innerText = TEST_INFO.title;

          //// Configure Test Harness ////
          setup({
            explicit_timeout: true,
          });

          //// Player Setup ////
          video = document.querySelector("video");
          player = new Player(video);
          player.init({ bufferTime: 30, numberOfSegmentBeforePlay: 2 });

          var contentModel = urlParams["content_model"];
          if (!contentModel)
            contentModel =
              "http://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Fragmented/ToS_MultiRate_fragmented.mpd"; // Temporary fix
          player.load(contentModel);

          player.addEventListener("onManifestParsed", function (manifest) {
            var totalSegmentsCount = manifest
              .getRepresentation(1)
              .getTotalSegmentsCount();
            player.setVideoSegments({
              representationNumber: 1,
              startSegment: 10,
              endSegment: totalSegmentsCount - 1,
            });
            player.startBuffering();
          });

          player.addEventListener("onSegmentLoaded", function (event) {
            if (event.totalSegmentsLoaded >= 2) {
              // Finish setup
              resolve();
            }
          });

          player.addEventListener("onPlayingSegmentChange", function (segment) {
            //console.log(segment);
          });

          //// Info Overlay Setup ////
          var infoOverlayElement = document.getElementById("info-overlay");
          var infoOverlay = new InfoOverlay(infoOverlayElement);
          infoOverlay.init();

          document.addEventListener("keydown", function (event) {
            if (event.keyCode === 38) {
              infoOverlay.show();
            }
            if (event.keyCode === 40) {
              infoOverlay.hide();
            }
          });

          player.addEventListener("onManifestParsed", function (manifest) {
            infoOverlay.updateOverlayInfo(player, TEST_INFO);
          });

          player.addEventListener("onTimeUpdate", function (currentTime) {
            infoOverlay.updateOverlayInfo(player, TEST_INFO);
          });

          player.addEventListener("onPlayingRepresentationChange", function (
            currentRepresentation
          ) {
            infoOverlay.updateOverlayInfo(player, TEST_INFO);
          });
        });
      }

      function executeTest(error) {
        if (error) return error;
        return new Promise(function (resolve) {
          // Start video playback
          player.play();

          // Placeholder test
          async_test(function (test) {
            document.addEventListener(
              "keydown",
              test.step_func(function (event) {
                if (event.keyCode !== 13) return;
                assert_true(true);
                test.done();
              })
            );
          }, "Placeholder subtest: Press Enter");

          // Finish test execution
          resolve();
        });
      }

      function initializeWaveService(error) {
        if (error) return error;
        return new Promise(function (resolve) {
          waveService = new WaveService();
          waveService
            .initialize("resources/wave-config")
            .then(function (error) {
              if (error) resolve("Failed to initialize wave service: " + error);
              resolve();
            });
        });
      }

      function sendTestReadyEvent(error) {
        if (error) return error;
        return new Promise(function (resolve) {
          var token = urlParams["token"];
          if (!token) {
            resolve("No session token provided");
            return;
          }
          waveService
            .sendSessionEvent(token, WaveService.TEST_READY_EVENT, TEST_INFO)
            .then(function () {
              resolve();
            });
        });
      }

      function waitForObservationReady(error) {
        if (error) return error;
        return new Promise(function (resolve) {
          var listener = function (event) {
            if (event.type !== WaveService.OBSERVATION_READY_EVENT) return;
            if (event.data.test_path !== TEST_INFO.path) return;
            waveService.removeSessionEventListener(listener);
            resolve();
          };
          var token = urlParams["token"];
          if (!token) {
            resolve("No session token provided");
            return;
          }
          waveService.addSessionEventListener(token, listener);
        });
      }
    </script>
  </body>
</html>
